{% extends 'admin_site/layout.html' %}
{% block 'main' %}
{% load static %}
{% load humanize %}

<div class="row" data-student-id="{{ student.pk }}">
    <!-- Profile Sidebar -->
    <div class="col-xl-4">
        <div class="card">
            <div class="card-body profile-card pt-4 d-flex flex-column align-items-center">
                <img {% if student.image %} src="{{ student.image.url }}" {% else %} src="https://placehold.co/120x120/EFEFEF/AAAAAA?text={{ student.first_name|first|upper }}" {% endif %} alt="Profile" class="rounded-circle" style="width: 120px; height: 120px; object-fit: cover;">
                <h2 class="mt-3">{{ student.first_name|title }} {{ student.last_name|title }}</h2>
                <h3>Reg. No: {{ student.registration_number }}</h3>
                <div class="mt-2">
                    <span class="badge bg-{{ student.get_status_color }}"><i class="bi bi-info-circle me-1"></i> {{ student.get_status_display }}</span>
                    {% if student.is_fingerprint_enrolled %}
                        <span class="badge bg-success ms-2"><i class="bi bi-fingerprint me-1"></i> Enrolled</span>
                    {% else %}
                        <span class="badge bg-warning ms-2"><i class="bi bi-fingerprint me-1"></i> Not Enrolled</span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Details Panel with Tabs -->
    <div class="col-xl-8">
        <div class="card">
            <div class="card-body pt-3">

                <!-- Tab Navigation -->
                <ul class="nav nav-tabs nav-tabs-bordered">
                    <li class="nav-item">
                        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#profile-overview">Profile Details</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#fingerprint-management">
                            <i class="bi bi-fingerprint me-1"></i>Fingerprint Management
                            {% if fingerprint_list|length > 0 %}
                                <span class="badge bg-primary ms-1">{{ fingerprint_list|length }}</span>
                            {% endif %}
                        </button>
                    </li>
                </ul>

                <div class="tab-content pt-2">
                    <!-- Profile Details Tab -->
                    <div class="tab-pane fade show active" id="profile-overview">
                        <div class="d-flex justify-content-between align-items-center mt-3">
                             <h5 class="card-title mb-0 pt-0">Student Profile</h5>
                            <div class="btn-group">
                                <a href="{% url 'student_edit' student.pk %}" class="btn btn-warning btn-sm" title="Edit Student"><i class="bi bi-pencil-square"></i> Edit</a>
                                <button type="button" class="btn btn-danger btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                   <i class="bi bi-gear"></i> Actions
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#confirmInactiveModal">Set as Inactive</a></li>
                                    <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#confirmGraduatedModal">Set as Graduated</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item text-danger" href="{% url 'student_delete' student.pk %}">Delete Student Record</a></li>
                                </ul>
                            </div>
                        </div>

                        <!-- Academic Info -->
                        <h6 class="card-subtitle mt-4 mb-2 text-muted">Academic Information</h6>
                        <div class="row border-top pt-3">
                            <div class="col-lg-3 col-md-4 label fw-bold">Registration No.</div>
                            <div class="col-lg-9 col-md-8">{{ student.registration_number }}</div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-lg-3 col-md-4 label fw-bold">Current Class</div>
                            <div class="col-lg-9 col-md-8">{{ student.student_class|default:"Not Assigned" }} {{ student.class_section|default:"" }}</div>
                        </div>

                        <h6 class="card-subtitle mt-4 mb-2 text-muted">Wallet Information</h6>
                        <div class="row border-top pt-3">
                            <div class="col-lg-3 col-md-4 label fw-bold">Balance</div>
                            <div class="col-lg-9 col-md-8">‚Ç¶{{ student.student_wallet.balance|floatformat|intcomma }}</div>
                        </div>

                        <h6 class="card-subtitle mt-4 mb-2 text-muted">Student Utilities</h6>
                        <div class="row border-top pt-3">
                            {% for utility in utility_list %}
                            <div class="col-lg-3 col-md-4 label fw-bold">{{ utility|title }}</div>
                            <div class="col-lg-9 col-md-8">
                                {% if utility in student.utilities.all %}
                                    <i class="bi bi-check-circle-fill text-success" title="Subscribed"></i>
                                {% else %}
                                    <i class="bi bi-x-circle-fill text-danger" title="Not Subscribed"></i>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>



                        <!-- Guardian Info -->
                        <h6 class="card-subtitle mt-4 mb-2 text-muted">Parent / Guardian Information</h6>
                        <div class="row border-top pt-3">
                            <div class="col-lg-3 col-md-4 label fw-bold">Name</div>
                            <div class="col-lg-9 col-md-8">{{ student.parent }}</div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-lg-3 col-md-4 label fw-bold">Contact</div>
                            <div class="col-lg-9 col-md-8">{{ student.parent.mobile }} | {{ student.parent.email }}</div>
                        </div>
                         <div class="row mt-2">
                            <div class="col-lg-3 col-md-4 label fw-bold"></div>
                            <div class="col-lg-9 col-md-8">
                                <a href="{% url 'parent_detail' student.parent.pk %}" class="btn btn-outline-primary btn-sm">
                                    <i class="bi bi-person-circle"></i> View Full Parent Profile
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Fingerprint Management Tab -->
                    <div class="tab-pane fade" id="fingerprint-management">
                        <div class="mt-3">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="card-subtitle mb-3 text-muted">
                                        <i class="bi bi-fingerprint me-2"></i>Registered Fingerprints
                                        <span class="badge bg-info ms-2">{{ fingerprint_list|length }}/{{ max_fingerprints }}</span>
                                    </h6>

                                    {% if fingerprint_list %}
                                        <div class="list-group">
                                            {% for fp in fingerprint_list %}
                                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                                <div>
                                                    <strong>{{ fp.get_finger_name_display }}</strong>
                                                    <small class="text-muted d-block">
                                                        Captured: {{ fp.created_at|date:"d M, Y H:i" }}
                                                        {% if fp.quality_score %}
                                                            <br>Quality: {{ fp.quality_score|floatformat:1 }}/1.0
                                                        {% endif %}
                                                        {% if fp.usage_count > 0 %}
                                                            <br>Used {{ fp.usage_count }} time{{ fp.usage_count|pluralize }}
                                                        {% endif %}
                                                    </small>
                                                </div>
                                                <button class="btn btn-outline-danger btn-sm" onclick="deleteFingerprintPrompt({{ fp.id }}, '{{ fp.get_finger_name_display }}')">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    {% else %}
                                        <div class="alert alert-light text-center">
                                            <i class="bi bi-fingerprint fs-2 text-muted"></i>
                                            <p class="mb-0 mt-2">No fingerprints have been registered for this student yet.</p>
                                        </div>
                                    {% endif %}
                                </div>

                                <div class="col-md-6">
                                    <h6 class="card-subtitle mb-3 text-muted">
                                        <i class="bi bi-plus-circle me-2"></i>Capture New Fingerprint
                                    </h6>

                                    <!-- Scanner Status Card -->
                                    <div class="card border-0 bg-light mb-3">
                                        <div class="card-body p-2">
                                            <div class="d-flex align-items-center">
                                                <div id="scanner-status-icon" class="me-2">
                                                    <i class="bi bi-question-circle text-warning"></i>
                                                </div>
                                                <small id="scanner-status-text" class="text-muted">Checking scanner...</small>
                                            </div>
                                            <div id="connected-readers" class="mt-2" style="display: none;">
                                                <small class="text-muted d-block">Connected devices:</small>
                                                <ul id="readers-list" class="mb-0" style="font-size: 0.85rem;"></ul>
                                            </div>
                                        </div>
                                    </div>

                                     <div class="border p-3 rounded">
                                        {% if can_add_more %}
                                            <div class="mb-3">
                                                <label for="finger-name-select" class="form-label">Select Finger to Register</label>
                                                <select id="finger-name-select" class="form-select">
                                                    <option value="">-- Choose a finger --</option>
                                                    <option value="LEFT_THUMB">Left Thumb</option>
                                                    <option value="LEFT_INDEX">Left Index</option>
                                                    <option value="LEFT_MIDDLE">Left Middle</option>
                                                    <option value="LEFT_RING">Left Ring</option>
                                                    <option value="LEFT_LITTLE">Left Little</option>
                                                    <option value="RIGHT_THUMB">Right Thumb</option>
                                                    <option value="RIGHT_INDEX">Right Index</option>
                                                    <option value="RIGHT_MIDDLE">Right Middle</option>
                                                    <option value="RIGHT_RING">Right Ring</option>
                                                    <option value="RIGHT_LITTLE">Right Little</option>
                                                </select>
                                            </div>

                                            <button class="btn btn-primary w-100" id="start-capture-btn" type="button" disabled>
                                                <i class="bi bi-fingerprint"></i> Start Capture
                                            </button>

                                            <button class="btn btn-danger w-100 mt-2" id="stop-capture-btn" type="button" style="display: none;">
                                                <i class="bi bi-stop-circle"></i> Stop Capture
                                            </button>

                                            <div class="mt-2 d-grid">
                                                <button class="btn btn-outline-secondary btn-sm" id="refresh-readers-btn" type="button">
                                                    <i class="bi bi-arrow-clockwise"></i> Refresh Devices
                                                </button>
                                            </div>
                                        {% else %}
                                            <div class="alert alert-warning text-center">
                                                <i class="bi bi-exclamation-triangle"></i>
                                                <p class="mb-0 mt-2">Maximum {{ max_fingerprints }} fingerprints allowed per student.</p>
                                                <small class="text-muted">Delete existing fingerprints to add new ones.</small>
                                            </div>
                                        {% endif %}

                                        <div id="scan-status" class="mt-3"></div>

                                        <!-- Captured Image Preview -->
                                        <div id="captured-preview" class="mt-3" style="display: none;">
                                            <h6 class="text-muted mb-2">Captured Fingerprint:</h6>
                                            <img id="captured-image" src="" alt="Captured fingerprint" class="img-fluid border rounded" style="max-width: 200px;">
                                        </div>
                                     </div>
                                </div>
                            </div>

                            <!-- Quick Actions -->
                            <div class="mt-4 pt-3 border-top">
                                <h6 class="text-muted mb-3">Quick Actions</h6>
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-outline-info btn-sm" onclick="testConnection()">
                                        <i class="bi bi-gear"></i> Test Connection
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="refreshPage()">
                                        <i class="bi bi-arrow-clockwise"></i> Refresh Page
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Confirmation Modals -->
<!-- Set as Inactive Modal -->
<div class="modal fade" id="confirmInactiveModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Status Change</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to set this student's status to <strong>Inactive</strong>?
      </div>
      <div class="modal-footer">
        <form method="post" action="{% url 'change_student_status' student.pk 'inactive' %}">
          {% csrf_token %}
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-warning">Yes, Set as Inactive</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Set as Graduated Modal -->
<div class="modal fade" id="confirmGraduatedModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Status Change</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to set this student's status to <strong>Graduated</strong>?
      </div>
      <div class="modal-footer">
        <form method="post" action="{% url 'change_student_status' student.pk 'graduated' %}">
          {% csrf_token %}
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">Yes, Set as Graduated</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Delete Fingerprint Modal -->
<div class="modal fade" id="deleteFingerprintModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Delete Fingerprint</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete the fingerprint for <strong id="delete-finger-name"></strong>?
        <br><small class="text-muted">This action cannot be undone.</small>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirm-delete-btn">
          <i class="bi bi-trash"></i> Delete Fingerprint
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Include DigitalPersona SDK - Use CDN like the working sample -->
<script type="text/javascript" src="https://unpkg.com/@digitalpersona/websdk@v1"></script>
<script type="text/javascript" src="https://unpkg.com/@digitalpersona/fingerprint@v1"></script>

<script>
/* ========= DigitalPersona Fingerprint Integration (Fixed) ========= */

// Global variables
let fingerprintApi = null;
let isCapturing = false;
let capturedSampleData = null;
const studentId = "{{ student.pk }}";

// Helper function to convert base64url to UTF-8 (from DP SDK)
function b64UrlToUtf8(b64url) {
    return Fingerprint.b64UrlToUtf8(b64url);
}

// Update scanner status UI
function updateScannerStatus(connected, message, readersCount = 0) {
    const icon = document.getElementById('scanner-status-icon');
    const text = document.getElementById('scanner-status-text');
    const readersDiv = document.getElementById('connected-readers');

    if (connected) {
        icon.innerHTML = '<i class="bi bi-check-circle text-success"></i>';
        text.textContent = message;
        text.className = 'text-success';

        if (readersCount > 0) {
            readersDiv.style.display = 'block';
        }
    } else {
        icon.innerHTML = '<i class="bi bi-x-circle text-danger"></i>';
        text.textContent = message;
        text.className = 'text-danger';
        readersDiv.style.display = 'none';
    }
}

// Show status messages
function showStatus(type, message) {
    const statusDiv = document.getElementById('scan-status');
    const alertClass = `alert-${type}`;
    const icons = {
        success: 'check-circle',
        danger: 'exclamation-triangle',
        warning: 'exclamation-triangle',
        info: 'info-circle'
    };
    const icon = icons[type] || 'info-circle';

    statusDiv.innerHTML = `
        <div class="alert ${alertClass} p-2 mb-0">
            <i class="bi bi-${icon} me-2"></i>${message}
        </div>
    `;
}

// Update readers list in UI
async function updateReadersList() {
    try {
        const readers = await fingerprintApi.enumerateDevices();
        const readersList = document.getElementById('readers-list');
        readersList.innerHTML = '';

        if (readers && readers.length > 0) {
            readers.forEach(reader => {
                const li = document.createElement('li');
                li.textContent = reader;
                readersList.appendChild(li);
            });
            updateScannerStatus(true, `${readers.length} device(s) connected`, readers.length);
            enableCaptureButton();
        } else {
            updateScannerStatus(false, 'No devices connected');
            disableCaptureButton();
        }
    } catch (error) {
        console.error('Error enumerating devices:', error);
        updateScannerStatus(false, 'Error detecting devices');
        disableCaptureButton();
    }
}

// Enable/disable capture button based on state
function enableCaptureButton() {
    const startBtn = document.getElementById('start-capture-btn');
    const fingerSelect = document.getElementById('finger-name-select');

    if (startBtn && fingerSelect && fingerSelect.value && !isCapturing) {
        startBtn.removeAttribute('disabled');
    }
}

function disableCaptureButton() {
    const startBtn = document.getElementById('start-capture-btn');
    if (startBtn) {
        startBtn.setAttribute('disabled', 'true');
    }
}

// Event Handlers for Fingerprint API

function onCommunicationFailed(event) {
    console.error('Communication failed:', event.error);
    showStatus('danger', `Connection error: ${event.error?.message || 'Unknown error'}`);
    updateScannerStatus(false, 'Agent communication failed');
}

function onDeviceConnected(event) {
    console.log('Device connected:', event.deviceUid);
    updateReadersList();
    showStatus('success', `Device connected: ${event.deviceUid}`);
}

function onDeviceDisconnected(event) {
    console.log('Device disconnected:', event.deviceUid);
    updateReadersList();
    showStatus('warning', `Device disconnected: ${event.deviceUid}`);
}

function onAcquisitionStarted(event) {
    console.log('Acquisition started on:', event.deviceUid);
    showStatus('info', 'üëÜ Place your finger on the scanner and hold steady...');
}

function onAcquisitionStopped(event) {
    console.log('Acquisition stopped on:', event.deviceUid);
    if (!capturedSampleData) {
        showStatus('info', 'Capture stopped.');
    }
}

function onSamplesAcquired(event) {
    console.log('Sample acquired on:', event.deviceUid);
    console.log('Sample data:', event.samples);

    try {
        const samples = JSON.parse(event.samples);

        if (samples && samples.length > 0) {
            const sample = samples[0];

            // Store the captured sample data (base64url encoded)
            capturedSampleData = {
                template: sample,
                quality: 0.85,
                deviceUid: event.deviceUid
            };

            // Convert to PNG image for preview - FIXED
            const binaryString = b64UrlToUtf8(sample);
            const imageData = `data:image/png;base64,${btoa(binaryString)}`;

            // Show preview
            const previewDiv = document.getElementById('captured-preview');
            const previewImg = document.getElementById('captured-image');
            previewImg.src = imageData;
            previewDiv.style.display = 'block';

            showStatus('success', '‚úÖ Fingerprint captured! Saving to server...');

            // Auto-stop capture
            stopCapture();

            // Save to server
            saveFingerprintToServer();

        } else {
            throw new Error('No samples in response');
        }

    } catch (error) {
        console.error('Error processing sample:', error);
        showStatus('danger', `Error processing fingerprint: ${error.message}`);
        stopCapture();
    }
}

function onQualityReported(event) {
    console.log('Quality reported:', event.quality, 'on device:', event.deviceUid);
}

function onErrorOccurred(event) {
    console.error('Error occurred:', event.error);
    showStatus('danger', `Scanner error: ${event.error?.message || 'Unknown error'}`);
    stopCapture();
}

// Initialize Fingerprint API
async function initializeFingerprintAPI() {
    try {
        console.log('Initializing DigitalPersona Fingerprint API...');

        // Check if Fingerprint API is available
        if (typeof Fingerprint === 'undefined' || !Fingerprint.WebApi) {
            throw new Error('DigitalPersona Fingerprint SDK not loaded');
        }

        // Create API instance
        fingerprintApi = new Fingerprint.WebApi({
            debug: true
        });

        // Register event handlers BEFORE any API calls
        fingerprintApi.onCommunicationFailed = onCommunicationFailed;
        fingerprintApi.onDeviceConnected = onDeviceConnected;
        fingerprintApi.onDeviceDisconnected = onDeviceDisconnected;
        fingerprintApi.onAcquisitionStarted = onAcquisitionStarted;
        fingerprintApi.onAcquisitionStopped = onAcquisitionStopped;
        fingerprintApi.onSamplesAcquired = onSamplesAcquired;
        fingerprintApi.onQualityReported = onQualityReported;
        fingerprintApi.onErrorOccurred = onErrorOccurred;

        console.log('Fingerprint API initialized successfully');

        // Give the API a moment to initialize before enumerating
        setTimeout(async () => {
            await updateReadersList();
        }, 500);

    } catch (error) {
        console.error('Failed to initialize Fingerprint API:', error);
        updateScannerStatus(false, `Initialization failed: ${error.message}`);
        showStatus('danger',
            '‚ùå Cannot initialize scanner. Please ensure:<br>' +
            '1. DigitalPersona Client/Agent is installed<br>' +
            '2. Agent service is running<br>' +
            '3. Scanner is connected'
        );
    }
}

// Start fingerprint capture
async function startCapture() {
    if (isCapturing) return;

    const fingerSelect = document.getElementById('finger-name-select');
    if (!fingerSelect || !fingerSelect.value) {
        showStatus('warning', '‚ö†Ô∏è Please select a finger to register.');
        return;
    }

    try {
        console.log('Starting acquisition...');
        capturedSampleData = null;

        // Hide previous preview
        document.getElementById('captured-preview').style.display = 'none';

        // Start acquisition with PNG format
        await fingerprintApi.startAcquisition(Fingerprint.SampleFormat.PngImage);

        isCapturing = true;

        // Update UI
        document.getElementById('start-capture-btn').style.display = 'none';
        document.getElementById('stop-capture-btn').style.display = 'block';
        document.getElementById('finger-name-select').setAttribute('disabled', 'true');

        showStatus('info', 'üëÜ Ready to scan. Place your finger on the scanner...');

    } catch (error) {
        console.error('Error starting capture:', error);
        showStatus('danger', `Failed to start capture: ${error.message}`);
        isCapturing = false;
    }
}

// Stop fingerprint capture
async function stopCapture() {
    if (!isCapturing) return;

    try {
        console.log('Stopping acquisition...');
        await fingerprintApi.stopAcquisition();

    } catch (error) {
        console.error('Error stopping capture:', error);
    } finally {
        isCapturing = false;

        // Update UI
        document.getElementById('start-capture-btn').style.display = 'block';
        document.getElementById('stop-capture-btn').style.display = 'none';
        document.getElementById('finger-name-select').removeAttribute('disabled');

        enableCaptureButton();
    }
}

// Convert base64url to standard base64
function base64urlToBase64(base64url) {
    let base64 = base64url.replace(/-/g, '+').replace(/_/g, '/');
    const padding = base64.length % 4;
    if (padding) {
        base64 += '='.repeat(4 - padding);
    }
    return base64;
}

// Save fingerprint to server
async function saveFingerprintToServer() {
    if (!capturedSampleData) {
        showStatus('danger', '‚ùå No fingerprint data to save');
        return;
    }

    const fingerSelect = document.getElementById('finger-name-select');
    const fingerName = fingerSelect.value;

    try {
        // Get CSRF token - improved selector
        const csrfToken = document.querySelector('input[name=csrfmiddlewaretoken]')?.value ||
                         document.querySelector('[name=csrfmiddlewaretoken]')?.value;

        if (!csrfToken) {
            throw new Error('CSRF token not found');
        }

        const standardBase64 = base64urlToBase64(capturedSampleData.template);

        showStatus('info', 'üîç Assessing fingerprint quality...');

        const response = await fetch('/admin/student/api/fingerprint/capture/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                student_id: studentId,
                finger_name: fingerName,
                fingerprint_data: standardBase64,
                quality_score: capturedSampleData.quality
            })
        });

        const data = await response.json();

        if (response.ok && data.success) {
            let successMessage = '‚úÖ Fingerprint saved successfully!';

            if (data.quality_feedback) {
                successMessage += ` Quality: ${data.quality_score?.toFixed(2)} - ${data.quality_feedback}`;
            }

            showStatus('success', successMessage);

            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            let errorMessage = data.message || 'Save failed';

            if (data.quality_score !== undefined) {
                errorMessage += ` (Quality: ${data.quality_score.toFixed(2)})`;
            }

            if (data.existing_student) {
                errorMessage += ` - Already registered for: ${data.existing_student}`;
            }

            if (data.feedback) {
                errorMessage += ` - ${data.feedback}`;
            }

            throw new Error(errorMessage);
        }

    } catch (error) {
        console.error('Error saving fingerprint:', error);

        let errorMessage = `‚ùå Failed to save: ${error.message}`;

        if (error.message.includes('quality')) {
            errorMessage += '<br>üí° Tip: Clean finger and scanner, apply steady pressure';
        } else if (error.message.includes('duplicate')) {
            errorMessage += '<br>üí° This fingerprint is already registered to another student';
        } else if (error.message.includes('already exists')) {
            errorMessage += '<br>üí° This finger is already registered for this student';
        }

        showStatus('danger', errorMessage);

        document.getElementById('start-capture-btn').style.display = 'block';
        document.getElementById('stop-capture-btn').style.display = 'none';
        document.getElementById('finger-name-select').removeAttribute('disabled');
    }
}

// Delete fingerprint
async function deleteFingerprint(fingerprintId) {
    try {
        // Improved CSRF token retrieval
        const csrfToken = document.querySelector('input[name=csrfmiddlewaretoken]')?.value ||
                         document.querySelector('[name=csrfmiddlewaretoken]')?.value;

        if (!csrfToken) {
            throw new Error('CSRF token not found');
        }

        const response = await fetch('/admin/student/api/fingerprint/delete/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ fingerprint_id: fingerprintId })
        });

        const data = await response.json();

        if (data.success) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('deleteFingerprintModal'));
            if (modal) modal.hide();

            showStatus('success', '‚úÖ Fingerprint deleted successfully! Refreshing...');
            setTimeout(() => location.reload(), 1200);
        } else {
            throw new Error(data.message || 'Delete failed');
        }
    } catch (error) {
        console.error('Delete error:', error);
        showStatus('danger', `‚ùå Error deleting fingerprint: ${error.message}`);
    }
}

// Helper functions for window scope
window.deleteFingerprintPrompt = function(fingerprintId, fingerName) {
    document.getElementById('delete-finger-name').textContent = fingerName;
    const confirmBtn = document.getElementById('confirm-delete-btn');
    confirmBtn.onclick = () => deleteFingerprint(fingerprintId);
    new bootstrap.Modal(document.getElementById('deleteFingerprintModal')).show();
};

window.testConnection = async function() {
    showStatus('info', 'üîç Testing scanner connection...');
    if (fingerprintApi) {
        await updateReadersList();
    } else {
        showStatus('danger', 'API not initialized. Try refreshing the page.');
    }
};

window.refreshPage = function() {
    location.reload();
};

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    console.log('Page loaded, initializing fingerprint system...');

    // Initialize fingerprint API
    initializeFingerprintAPI();

    // Finger selection change handler
    const fingerSelect = document.getElementById('finger-name-select');
    if (fingerSelect) {
        fingerSelect.addEventListener('change', function() {
            enableCaptureButton();
        });
    }

    // Start capture button
    const startBtn = document.getElementById('start-capture-btn');
    if (startBtn) {
        startBtn.addEventListener('click', startCapture);
    }

    // Stop capture button
    const stopBtn = document.getElementById('stop-capture-btn');
    if (stopBtn) {
        stopBtn.addEventListener('click', stopCapture);
    }

    // Refresh readers button
    const refreshBtn = document.getElementById('refresh-readers-btn');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', async function() {
            refreshBtn.setAttribute('disabled', 'true');
            await updateReadersList();
            setTimeout(() => refreshBtn.removeAttribute('disabled'), 500);
        });
    }
});

// Debug helper
window.debugFingerprint = function() {
    console.log('=== Fingerprint Debug Info ===');
    console.log('API initialized:', fingerprintApi !== null);
    console.log('Is capturing:', isCapturing);
    console.log('Captured data:', capturedSampleData);
    console.log('Fingerprint SDK available:', typeof Fingerprint !== 'undefined');
    console.log('WebApi available:', typeof Fingerprint?.WebApi !== 'undefined');
    console.log('============================');

    if (fingerprintApi) {
        fingerprintApi.enumerateDevices()
            .then(devices => console.log('Connected devices:', devices))
            .catch(err => console.error('Error enumerating devices:', err));
    }
};

console.log('üí° Fingerprint system ready!');
console.log('üí° Debug command: window.debugFingerprint()');
</script>

{% endblock %}