{% extends "parent_portal/layout.html" %}
{% load humanize %}
{% load static %}

{% block content %}

<div class="pagetitle">
    <h1>School Bank Accounts</h1>
    <nav>
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'parent_dashboard' %}">Home</a></li>
            <li class="breadcrumb-item active">Account Details</li>
        </ol>
    </nav>
</div><!-- End Page Title -->

<section class="section">
    <div class="row">

        <!-- Card 1: Student Wallet Funding -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-wallet2 me-2 text-primary"></i>Student Wallet Funding</h5>
                    <p class="small">
                        Please use this account **only** for funding your student's personal wallet (e.g., for cafeteria, store purchases, or pocket money).
                    </p>

                    {% if funding_account.account_number %}
                        <dl class="row mt-3">
                            <dt class="col-sm-4">Bank</dt>
                            <dd class="col-sm-8">{{ funding_account.bank }}</dd>

                            <dt class="col-sm-4">Account Name</dt>
                            <dd class="col-sm-8">{{ funding_account.account_name }}</dd>

                            <dt class="col-sm-4">Account Number</dt>
                            <dd class="col-sm-8">
                                <span id="funding-acc-num">{{ funding_account.account_number }}</span>
                                <button class="btn btn-outline-secondary btn-sm py-0 px-2 ms-2" 
                                        onclick="copyToClipboard('{{ funding_account.account_number }}', this)">
                                    <i class="bi bi-clipboard"></i> 
                                    <span class="copy-text">Copy</span>
                                </button>
                            </dd>
                        </dl>
                    {% else %}
                        <div class="alert alert-warning text-center">
                            Student funding account details are not available at this time.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Card 2: School Fee Payments -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-building me-2 text-success"></i>School Fee Payments</h5>
                    <p class="small">
                        Please use any of the accounts below when paying official school fees (e.g., Tuition, Bus Fees, PTA Levies).
                    </p>

                    {% if school_account_list %}
                        <ul class="list-group list-group-flush">
                            {% for account in school_account_list %}

                                    <li class="list-group-item px-0">
                                        <div class="d-flex w-100 justify-content-between">
                                            <h6 class="mb-1">{{ account.bank_name }}</h6>
                                        </div>
                                        <p class="mb-1">{{ account.account_name }}</p>
                                        <div class="d-flex w-100 justify-content-between">
                                            <strong class="text-dark" id="fee-acc-num-{{ forloop.counter }}">{{ account.account_number }}</strong>
                                            <button class="btn btn-outline-success btn-sm py-0 px-2" 
                                                    onclick="copyToClipboard('{{ account.account_number }}', this)">
                                                <i class="bi bi-clipboard"></i> 
                                                <span class="copy-text">Copy</span>
                                            </button>
                                        </div>
                                    </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <div class="alert alert-warning text-center">
                            School fee payment account details are not available at this time.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

    </div>
</section>

<!-- Hidden textarea for copy-to-clipboard functionality -->
<textarea id="clipboard-helper" style="position: absolute; left: -9999px;"></textarea>

<script>
function copyToClipboard(text, buttonElement) {
    const helperTextarea = document.getElementById('clipboard-helper');
    helperTextarea.value = text;
    helperTextarea.select();
    helperTextarea.setSelectionRange(0, 99999); // For mobile devices

    try {
        // Use execCommand as per instructions for iFrame compatibility
        document.execCommand('copy');
        
        // Visual feedback
        if (buttonElement) {
            const copyText = buttonElement.querySelector('.copy-text');
            const originalText = copyText.innerHTML;
            copyText.innerHTML = "Copied!";
            buttonElement.classList.remove('btn-outline-secondary', 'btn-outline-success');
            buttonElement.classList.add('btn-success');

            setTimeout(() => {
                copyText.innerHTML = originalText;
                buttonElement.classList.remove('btn-success');
                if (buttonElement.classList.contains('text-success')) {
                     buttonElement.classList.add('btn-outline-success');
                } else {
                     buttonElement.classList.add('btn-outline-secondary');
                }
            }, 2000);
        }

    } catch (err) {
        console.error('Failed to copy text: ', err);
        // Fallback for user (though alert is discouraged, it's a fallback)
        const copyText = buttonElement.querySelector('.copy-text');
        copyText.innerHTML = "Error!";
    }
}
</script>

{% endblock %}
