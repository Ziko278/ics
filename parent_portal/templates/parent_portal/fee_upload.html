{% extends "parent_portal/layout.html" %}
{% load humanize %}

{% block title %}{% if transaction_type == 'wallet' %}Fund Wallet{% else %}Upload Fee Proof{% endif %} - {{ selected_ward.first_name }}{% endblock %}

{% block content %}
<div class="pagetitle">
  <h1>{% if transaction_type == 'wallet' %}Fund Student Wallet{% else %}Upload Fee Payment Proof{% endif %}</h1>
  <nav>
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{% url 'parent_dashboard' %}">Dashboard</a></li>
      <li class="breadcrumb-item">Fees</li>
      <li class="breadcrumb-item active">{% if transaction_type == 'wallet' %}Fund Wallet{% else %}Upload Proof{% endif %}</li>
    </ol>
  </nav>
</div>
<section class="section">
    <div class="row">
        <div class="col-lg-7">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        {% if transaction_type == 'wallet' %}
                        Submit Wallet Funding Details for {{ selected_ward.first_name }} {{ selected_ward.last_name }}
                        {% else %}
                        Submit Fee Payment Details for {{ selected_ward.first_name }} {{ selected_ward.last_name }}
                        {% endif %}
                    </h5>
                    <p>
                        {% if transaction_type == 'wallet' %}
                        Please fill in the details of the payment you made to the wallet account and upload a clear picture or screenshot of the teller/transfer confirmation.
                        {% else %}
                        Please fill in the details of the payment you made and upload a clear picture or screenshot of the teller/transfer confirmation.
                        {% endif %}
                    </p>

                    {# --- Display Messages --- #}
                    {% if messages %}
                        {% for message in messages %}
                        <div class="alert alert-{{ message.tags }} {% if message.tags == 'error' %}alert-danger{% endif %} alert-dismissible fade show" role="alert">
                             {% if message.tags == 'success' %}<i class="bi bi-check-circle me-1"></i>{% endif %}
                             {% if message.tags == 'warning' %}<i class="bi bi-exclamation-triangle me-1"></i>{% endif %}
                             {% if message.tags == 'info' %}<i class="bi bi-info-circle me-1"></i>{% endif %}
                             {% if message.tags == 'error' %}<i class="bi bi-exclamation-octagon me-1"></i>{% endif %}
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                        {% endfor %}
                    {% endif %}

                    {# --- Form --- #}
                    <form method="post" enctype="multipart/form-data" class="row g-3 needs-validation" id="paymentForm">
                        {% csrf_token %}

                        {# Target Invoice Field #}
                        {% if form.target_invoice %}
                        <div class="col-12">
                             <label for="{{ form.target_invoice.id_for_label }}" class="form-label">
                                {{ form.target_invoice.label }}
                                {% if form.target_invoice.field.required %}<span class="text-danger">*</span>{% endif %}
                             </label>
                             {{ form.target_invoice }}
                             <small class="text-muted">Select the invoice this payment is for.</small>
                             {% if form.target_invoice.errors %}
                                <div class="text-danger small mt-1">{{ form.target_invoice.errors|striptags }}</div>
                             {% endif %}
                        </div>

                        {# Payment Type Selection - Only show for fee payments #}
                        <div class="col-12" id="paymentTypeSection">
                            <label class="form-label">Payment Type <span class="text-danger">*</span></label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="payment_type" id="quickPayment" value="quick" checked>
                                <label class="form-check-label" for="quickPayment">
                                    <strong>Quick Payment</strong> - Pay any amount, system will distribute automatically
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="payment_type" id="itemizedPayment" value="itemized">
                                <label class="form-check-label" for="itemizedPayment">
                                    <strong>Select Specific Fees</strong> - Choose which fees to pay
                                </label>
                            </div>
                        </div>
                        {% endif %}

                        <!-- After form.target_invoice block and before Payment Type Selection -->
                        {% if form.wallet_type %}
                        <div class="col-12">
                            <label for="{{ form.wallet_type.id_for_label }}" class="form-label">
                                {{ form.wallet_type.label }}
                                <span class="text-danger">*</span>
                            </label>
                            {{ form.wallet_type }}
                            <small class="text-muted">Select which wallet to fund.</small>
                            {% if form.wallet_type.errors %}
                                <div class="text-danger small mt-1">{{ form.wallet_type.errors|striptags }}</div>
                            {% endif %}
                        </div>
                        {% endif %}

                        {# Quick Payment Section #}
                        <div id="quickPaymentSection">
                            <div class="col-md-6">
                                <label for="{{ form.amount.id_for_label }}" class="form-label">Amount Paid (₦) <span class="text-danger">*</span></label>
                                {{ form.amount }}
                                {% if form.amount.errors %}
                                    <div class="text-danger small mt-1">{{ form.amount.errors|striptags }}</div>
                                {% endif %}
                            </div>
                        </div>

                        {# Itemized Payment Section (Hidden by default) #}
                        {% if form.target_invoice %}
                        <div id="itemizedPaymentSection" style="display: none;">
                            <div class="col-12">
                                <h6 class="mb-3">Select Fees to Pay</h6>
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle"></i> Enter the amount you want to pay for each fee. The total must match your payment amount.
                                </div>

                                {# This will be populated via AJAX when invoice is selected #}
                                <div id="invoiceItemsContainer">
                                    <p class="text-muted">Please select an invoice first to see available fees.</p>
                                </div>

                                <div class="mt-3 p-3 bg-light border rounded">
                                    <div class="d-flex justify-content-between">
                                        <strong>Total Selected:</strong>
                                        <strong id="totalSelected" class="text-primary">₦0.00</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        {# Common Payment Fields #}
                        <div class="col-md-6">
                            <label for="{{ form.method.id_for_label }}" class="form-label">Payment Method <span class="text-danger">*</span></label>
                            {{ form.method }}
                             {% if form.method.errors %}
                                <div class="text-danger small mt-1">{{ form.method.errors|striptags }}</div>
                             {% endif %}
                        </div>

                        <div class="col-12">
                            <label for="{{ form.proof_of_payment.id_for_label }}" class="form-label">{{ form.proof_of_payment.label }} <span class="text-danger">*</span></label>
                            {{ form.proof_of_payment }}
                             <small class="text-muted">Max file size: 5MB. Allowed types: jpg, png, pdf.</small>
                             {% if form.proof_of_payment.errors %}
                                <div class="text-danger small mt-1">{{ form.proof_of_payment.errors|striptags }}</div>
                             {% endif %}
                        </div>

                        {# Hidden field to store teller number if needed #}
                        <input type="hidden" name="teller_number" value="">

                        {# Submit/Cancel Buttons #}
                        <div class="text-center mt-4">
                            <button type="submit" class="btn btn-primary"><i class="bi bi-check-lg"></i> Submit for Review</button>
                            <a href="{% url 'parent_fee_list' %}" class="btn btn-secondary"><i class="bi bi-x-lg"></i> Cancel</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        {# --- Bank Details Column --- #}
        <div class="col-lg-5">
            {% if transaction_type == 'wallet' %}
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-wallet2 me-2 text-primary"></i>
                        {% if transaction_type == 'wallet' %}Wallet Funding Account{% endif %}
                    </h5>
                    <p class="small">
                        {% if transaction_type == 'wallet' %}
                        Please use this account for funding the student's wallet (canteen or fee wallet).
                        {% endif %}
                    </p>
                    {% if funding_account.account_number %}
                        <dl class="row mt-3">
                            <dt class="col-sm-4">Bank</dt>
                            <dd class="col-sm-8">{{ funding_account.bank }}</dd>
                            <dt class="col-sm-4">Account Name</dt>
                            <dd class="col-sm-8">{{ funding_account.account_name }}</dd>
                            <dt class="col-sm-4">Account Number</dt>
                            <dd class="col-sm-8">
                                <span id="funding-acc-num">{{ funding_account.account_number }}</span>
                                <button type="button" class="btn btn-outline-secondary btn-sm py-0 px-2 ms-2"
                                        onclick="copyToClipboard('{{ funding_account.account_number }}', this)">
                                    <i class="bi bi-clipboard"></i> <span class="copy-text">Copy</span>
                                </button>
                            </dd>
                        </dl>
                        <p class="small text-muted mt-2">Please use your child's full name or registration number as the payment reference/narration.</p>
                    {% else %}
                        <div class="alert alert-warning text-center">Student funding account details are not available at this time.</div>
                    {% endif %}
                </div>
            </div>
            {% else %}
            <div class="card">
                 <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-bank"></i> School Fee Account Details</h5>
                    <p class="small">Please use any of the accounts below when paying official school fees.</p>
                    {% if bank_details %}
                        <ul class="list-group list-group-flush">
                        {% for detail in bank_details %}
                            <li class="list-group-item px-0">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">{{ detail.bank_name }}</h6>
                                </div>
                                <p class="mb-1">{{ detail.account_name }}</p>
                                <div class="d-flex w-100 justify-content-between">
                                    <strong class="text-dark">{{ detail.account_number }}</strong>
                                    <button type="button" class="btn btn-outline-success btn-sm py-0 px-2"
                                            onclick="copyToClipboard('{{ detail.account_number }}', this)">
                                        <i class="bi bi-clipboard"></i> <span class="copy-text">Copy</span>
                                    </button>
                                </div>
                            </li>
                        {% endfor %}
                        </ul>
                         <p class="small text-muted mt-2">Please use your child's full name or registration number as the payment reference/narration.</p>
                    {% else %}
                        <div class="alert alert-secondary">Bank details not available. Please contact the school administration.</div>
                    {% endif %}
                 </div>
            </div>
            {% endif %}

            <div class="card">
                 <div class="card-body">
                     <h5 class="card-title"><i class="bi bi-question-circle"></i> Need Help?</h5>
                     <p>If you encounter any issues uploading your payment proof or have questions about fees, please contact the school administration office.</p>
                     {% if school_info.mobile or school_info.email %}
                        <p>
                            {% if school_info.mobile %}<strong>Phone:</strong> {{ school_info.mobile }}<br>{% endif %}
                            {% if school_info.email %}<strong>Email:</strong> {{ school_info.email }}{% endif %}
                        </p>
                     {% endif %}
                 </div>
            </div>
        </div>
    </div>
</section>

<textarea id="clipboard-helper" style="position: absolute; left: -9999px;"></textarea>

<script>
// Payment type toggle
document.addEventListener('DOMContentLoaded', function() {
    const quickRadio = document.getElementById('quickPayment');
    const itemizedRadio = document.getElementById('itemizedPayment');
    const quickSection = document.getElementById('quickPaymentSection');
    const itemizedSection = document.getElementById('itemizedPaymentSection');
    const invoiceSelect = document.querySelector('select[name="target_invoice"]');

    if (quickRadio && itemizedRadio) {
        quickRadio.addEventListener('change', function() {
            if (this.checked) {
                quickSection.style.display = 'block';
                itemizedSection.style.display = 'none';
            }
        });

        itemizedRadio.addEventListener('change', function() {
            if (this.checked) {
                quickSection.style.display = 'none';
                itemizedSection.style.display = 'block';

                // Load invoice items if invoice is selected
                if (invoiceSelect && invoiceSelect.value) {
                    loadInvoiceItems(invoiceSelect.value);
                }
            }
        });

        // Load items when invoice changes in itemized mode
        if (invoiceSelect) {
            invoiceSelect.addEventListener('change', function() {
                if (itemizedRadio.checked && this.value) {
                    loadInvoiceItems(this.value);
                }
            });
        }
    }
});

// Load invoice items via current page reload with invoice_id param
function loadInvoiceItems(invoiceId) {
    const container = document.getElementById('invoiceItemsContainer');
    container.innerHTML = '<div class="text-center"><div class="spinner-border spinner-border-sm" role="status"></div> Loading fees...</div>';

    // Fetch invoice data - you'll need to create an endpoint or embed data
    fetch(`/admin/finance/get-invoice-items/${invoiceId}/`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.items && data.items.length > 0) {
            let html = '<div class="table-responsive"><table class="table table-sm table-bordered">';
            html += '<thead><tr><th>Fee Description</th><th class="text-end">Amount</th><th class="text-end">Discount</th><th class="text-end">Balance</th><th style="width: 150px;">Pay Amount</th></tr></thead><tbody>';

            data.items.forEach(item => {
                if (item.balance > 0 && !item.paid_by_sibling) {
                    html += `<tr>
                        <td>
                            ${item.description}
                            ${item.paid_by_sibling ? '<br><small class="text-success"><i class="bi bi-check-circle"></i> Paid by sibling</small>' : ''}
                        </td>
                        <td class="text-end">₦${parseFloat(item.amount).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td class="text-end text-success">₦${parseFloat(item.total_discount).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td class="text-end text-danger">₦${parseFloat(item.balance).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td>
                            <input type="number" name="item_${item.id}" class="form-control form-control-sm item-payment"
                                   placeholder="0.00" min="0" max="${item.balance}" step="0.01"
                                   data-item-id="${item.id}" onchange="updateTotal()">
                        </td>
                    </tr>`;
                }
            });

            html += '</tbody></table></div>';

            if (data.items.filter(i => i.balance > 0 && !i.paid_by_sibling).length === 0) {
                html = '<div class="alert alert-success">All fees on this invoice have been paid!</div>';
            }

            container.innerHTML = html;
        } else {
            container.innerHTML = '<div class="alert alert-warning">No unpaid fees found on this invoice.</div>';
        }
    })
    .catch(error => {
        console.error('Error loading items:', error);
        container.innerHTML = '<div class="alert alert-danger">Error loading fees. Please try again.</div>';
    });
}

// Update total selected amount
function updateTotal() {
    const inputs = document.querySelectorAll('.item-payment');
    let total = 0;

    inputs.forEach(input => {
        const value = parseFloat(input.value) || 0;
        total += value;
    });

    const totalElement = document.getElementById('totalSelected');
    if (totalElement) {
        totalElement.textContent = '₦' + total.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});

        // Visual feedback
        if (total > 0) {
            totalElement.classList.add('text-success');
            totalElement.classList.remove('text-primary');
        } else {
            totalElement.classList.add('text-primary');
            totalElement.classList.remove('text-success');
        }
    }
}

// Copy to clipboard function
function copyToClipboard(text, buttonElement) {
    const helperTextarea = document.getElementById('clipboard-helper');
    if (!helperTextarea) return;

    helperTextarea.value = text;
    helperTextarea.select();
    helperTextarea.setSelectionRange(0, 99999);

    try {
        document.execCommand('copy');

        if (buttonElement) {
            const copyText = buttonElement.querySelector('.copy-text');
            const originalText = copyText.innerHTML;
            const originalIcon = buttonElement.querySelector('i').className;

            copyText.innerHTML = "Copied!";
            buttonElement.querySelector('i').className = "bi bi-check-lg";
            buttonElement.classList.remove('btn-outline-secondary', 'btn-outline-success');
            buttonElement.classList.add('btn-success');

            setTimeout(() => {
                copyText.innerHTML = originalText;
                buttonElement.querySelector('i').className = originalIcon;
                buttonElement.classList.remove('btn-success');
                if (buttonElement.closest('.card-body').querySelector('.text-primary')) {
                     buttonElement.classList.add('btn-outline-secondary');
                } else {
                     buttonElement.classList.add('btn-outline-success');
                }
            }, 2000);
        }
    } catch (err) {
        console.error('Failed to copy:', err);
    }
}
</script>

{% endblock %}