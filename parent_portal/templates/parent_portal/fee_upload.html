{% extends "parent_portal/layout.html" %}
{% load humanize %}

{% block title %}{% if transaction_type == 'wallet' %}Fund Wallet{% else %}Upload Fee Proof{% endif %} - {{ selected_ward.first_name }}{% endblock %}

{% block content %}
<div class="pagetitle">
  <h1>{% if transaction_type == 'wallet' %}Fund Student Wallet{% else %}Upload Fee Payment Proof{% endif %}</h1>
  <nav>
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{% url 'parent_dashboard' %}">Dashboard</a></li>
      <li class="breadcrumb-item">Fees</li>
      <li class="breadcrumb-item active">{% if transaction_type == 'wallet' %}Fund Wallet{% else %}Upload Proof{% endif %}</li>
    </ol>
  </nav>
</div>
<section class="section">
    <div class="row">
        <div class="col-lg-7">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        {% if transaction_type == 'wallet' %}
                        Submit Wallet Funding Details for {{ selected_ward.first_name }} {{ selected_ward.last_name }}
                        {% else %}
                        Submit Fee Payment Details for {{ selected_ward.first_name }} {{ selected_ward.last_name }}
                        {% endif %}
                    </h5>
                    <p>
                        {% if transaction_type == 'wallet' %}
                        Please fill in the details of the payment you made to the wallet account and upload a clear picture or screenshot of the teller/transfer confirmation.
                        {% else %}
                        Please fill in the details of the payment you made and upload a clear picture or screenshot of the teller/transfer confirmation. You can optionally link this payment directly to an outstanding invoice.
                        {% endif %}
                    </p>

                    {# --- Display Messages (including form errors from view) --- #}
                    {% if messages %}
                        {% for message in messages %}
                        <div class="alert alert-{{ message.tags }} {% if message.tags == 'error' %}alert-danger{% endif %} alert-dismissible fade show" role="alert">
                             {% if message.tags == 'success' %}<i class="bi bi-check-circle me-1"></i>{% endif %}
                             {% if message.tags == 'warning' %}<i class="bi bi-exclamation-triangle me-1"></i>{% endif %}
                             {% if message.tags == 'info' %}<i class="bi bi-info-circle me-1"></i>{% endif %}
                             {% if message.tags == 'error' %}<i class="bi bi-exclamation-octagon me-1"></i>{% endif %}
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                        {% endfor %}
                    {% endif %}
                    {# --- End Messages --- #}

                    {# --- Form --- #}
                    <form method="post" enctype="multipart/form-data" class="row g-3 needs-validation">
                        {% csrf_token %}

                        {# Target Invoice Field - Conditionally rendered #}
                        {% if form.target_invoice %}
                        <div class="col-12">
                             <label for="{{ form.target_invoice.id_for_label }}" class="form-label">
                                {{ form.target_invoice.label }}
                                {% if form.target_invoice.field.required %}<span class="text-danger">*</span>{% endif %}
                             </label>
                             {{ form.target_invoice }}
                             <small class="text-muted">
                                {% if transaction_type == 'fee' %}
                                Select the invoice this payment is for.
                                {% else %}
                                Select an invoice to apply this payment directly to it, or leave as 'General' to fund the student's wallet.
                                {% endif %}
                             </small>
                             {% if form.target_invoice.errors %}
                                <div class="text-danger small mt-1">{{ form.target_invoice.errors|striptags }}</div>
                             {% endif %}
                        </div>
                        {% endif %} {# End conditional invoice field #}

                        {# Amount Field #}
                        <div class="col-md-6">
                            <label for="{{ form.amount.id_for_label }}" class="form-label">Amount Paid (â‚¦) <span class="text-danger">*</span></label>
                            {{ form.amount }}
                            {% if form.amount.errors %}
                                <div class="text-danger small mt-1">{{ form.amount.errors|striptags }}</div>
                            {% endif %}
                        </div>

                        {# Payment Method Field #}
                        <div class="col-md-6">
                            <label for="{{ form.method.id_for_label }}" class="form-label">Payment Method <span class="text-danger">*</span></label>
                            {{ form.method }}
                             {% if form.method.errors %}
                                <div class="text-danger small mt-1">{{ form.method.errors|striptags }}</div>
                             {% endif %}
                        </div>

                        {# Proof of Payment Field #}
                        <div class="col-12">
                            <label for="{{ form.proof_of_payment.id_for_label }}" class="form-label">{{ form.proof_of_payment.label }} <span class="text-danger">*</span></label>
                            {{ form.proof_of_payment }}
                             <small class="text-muted">Max file size: 5MB. Allowed types: jpg, png, pdf.</small>
                             {% if form.proof_of_payment.errors %}
                                <div class="text-danger small mt-1">{{ form.proof_of_payment.errors|striptags }}</div>
                             {% endif %}
                        </div>

                        {# Submit/Cancel Buttons #}
                        <div class="text-center mt-4">
                            <button type="submit" class="btn btn-primary"><i class="bi bi-check-lg"></i> Submit for Review</button>
                            <a href="{% url 'parent_fee_list' %}" class="btn btn-secondary"><i class="bi bi-x-lg"></i> Cancel</a>
                        </div>
                    </form> {# --- End Form --- #}
                </div> {# End Card Body #}
            </div> {# End Card #}
        </div> {# End Form Column #}

        {# --- Bank Details Column --- #}
        <div class="col-lg-5">

            {% if transaction_type == 'wallet' %}
            {# --- Wallet Account Details --- #}
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-wallet2 me-2 text-primary"></i>Wallet Funding Account</h5>
                    <p class="small">
                        Please use this account **only** for funding the student's personal wallet.
                    </p>
                    {% if funding_account.account_number %}
                        <dl class="row mt-3">
                            <dt class="col-sm-4">Bank</dt>
                            <dd class="col-sm-8">{{ funding_account.bank }}</dd>
                            <dt class="col-sm-4">Account Name</dt>
                            <dd class="col-sm-8">{{ funding_account.account_name }}</dd>
                            <dt class="col-sm-4">Account Number</dt>
                            <dd class="col-sm-8">
                                <span id="funding-acc-num">{{ funding_account.account_number }}</span>
                                <button type="button" class="btn btn-outline-secondary btn-sm py-0 px-2 ms-2"
                                        onclick="copyToClipboard('{{ funding_account.account_number }}', this)">
                                    <i class="bi bi-clipboard"></i>
                                    <span class="copy-text">Copy</span>
                                </button>
                            </dd>
                        </dl>
                        <p class="small text-muted mt-2">Please use your child's full name or registration number as the payment reference/narration.</p>
                    {% else %}
                        <div class="alert alert-warning text-center">
                            Student funding account details are not available at this time.
                        </div>
                    {% endif %}
                </div>
            </div>

            {% else %}
            {# --- Fee Account Details --- #}
            <div class="card">
                 <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-bank"></i> School Fee Account Details</h5>
                    <p class="small">
                        Please use any of the accounts below when paying official school fees.
                    </p>
                    {% if bank_details %}
                        <ul class="list-group list-group-flush">
                        {% for detail in bank_details %}
                            <li class="list-group-item px-0">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">{{ detail.bank_name }}</h6>
                                </div>
                                <p class="mb-1">{{ detail.account_name }}</p>
                                <div class="d-flex w-100 justify-content-between">
                                    <strong class="text-dark" id="fee-acc-num-{{ forloop.counter }}">{{ detail.account_number }}</strong>
                                    <button type="button" class="btn btn-outline-success btn-sm py-0 px-2"
                                            onclick="copyToClipboard('{{ detail.account_number }}', this)">
                                        <i class="bi bi-clipboard"></i>
                                        <span class="copy-text">Copy</span>
                                    </button>
                                </div>
                            </li>
                        {% endfor %}
                        </ul>
                         <p class="small text-muted mt-2">Please use your child's full name or registration number as the payment reference/narration.</p>
                    {% else %}
                        <div class="alert alert-secondary">Bank details not available. Please contact the school administration.</div>
                    {% endif %}
                 </div>
            </div>
            {% endif %} {# End conditional bank details #}


            <div class="card">
                 <div class="card-body">
                     <h5 class="card-title"><i class="bi bi-question-circle"></i> Need Help?</h5>
                     <p>If you encounter any issues uploading your payment proof or have questions about fees, please contact the school administration office.</p>
                     {% if school_info.mobile or school_info.email %}
                        <p>
                            {% if school_info.mobile %}<strong>Phone:</strong> {{ school_info.mobile }}<br>{% endif %}
                            {% if school_info.email %}<strong>Email:</strong> {{ school_info.email }}{% endif %}
                        </p>
                     {% endif %}
                 </div>
            </div> {# End Help Card #}
        </div> {# End Info Column #}
    </div> {# End Row #}
</section>

<textarea id="clipboard-helper" style="position: absolute; left: -9999px;"></textarea>

<script>
function copyToClipboard(text, buttonElement) {
    const helperTextarea = document.getElementById('clipboard-helper');
    if (!helperTextarea) {
        console.error('Clipboard helper textarea not found');
        return;
    }
    helperTextarea.value = text;
    helperTextarea.select();
    helperTextarea.setSelectionRange(0, 99999); // For mobile devices

    try {
        var successful = document.execCommand('copy');

        if (successful && buttonElement) {
            const copyText = buttonElement.querySelector('.copy-text');
            const originalText = copyText.innerHTML;
            const originalIcon = buttonElement.querySelector('i').className;

            copyText.innerHTML = "Copied!";
            buttonElement.querySelector('i').className = "bi bi-check-lg"; // Change icon to check

            buttonElement.classList.remove('btn-outline-secondary', 'btn-outline-success');
            buttonElement.classList.add('btn-success'); // Make button solid success

            setTimeout(() => {
                copyText.innerHTML = originalText;
                buttonElement.querySelector('i').className = originalIcon; // Restore icon
                buttonElement.classList.remove('btn-success');
                // Restore correct outline color
                if (buttonElement.closest('.card-body').querySelector('.text-primary')) {
                     buttonElement.classList.add('btn-outline-secondary');
                } else {
                     buttonElement.classList.add('btn-outline-success');
                }
            }, 2000);
        }

    } catch (err) {
        console.error('Failed to copy text: ', err);
        if (buttonElement) {
            const copyText = buttonElement.querySelector('.copy-text');
            copyText.innerHTML = "Error!";
        }
    }
}
</script>

{% endblock %}