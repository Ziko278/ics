{% extends 'admin_site/layout.html' %}
{% load static %}
{% block 'main' %}

<div class="col-lg-12 grid-margin stretch-card">
    <div class="card">
        <div class="card-body">
            <div class="d-flex align-items-start mb-3">
                <div class="me-auto">
                    <h4 class="card-title">{{ page_title|default:"Salary Setting Detail" }}</h4>
                    {% if setting.description %}
                        <p class="text-muted mb-0">{{ setting.description }}</p>
                    {% endif %}
                    <small class="text-muted">Effective: {{ setting.effective_from }}{% if setting.effective_to %} — {{ setting.effective_to }}{% endif %}</small>
                </div>

                <div class="text-end">
                    <div class="mb-2">
                        {% if setting.is_locked %}
                            <span class="badge bg-danger"><i class="bi bi-lock-fill"></i> Locked</span>
                        {% elif setting.is_active %}
                            <span class="badge bg-success"><i class="bi bi-check-circle-fill"></i> Active</span>
                        {% else %}
                            <span class="badge bg-secondary"><i class="bi bi-pause-circle"></i> Inactive</span>
                        {% endif %}
                    </div>

                    <div class="btn-group" role="group">
                        <form method="post" class="d-inline">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="{% if not setting.is_active %}activate{% else %}deactivate{% endif %}">
                            {% if not setting.is_locked %}
                                <button type="submit" class="btn {% if not setting.is_active %} btn-success {% else %} btn-warning {% endif %} btn-sm me-1">
                                    {% if not setting.is_active %}<i class="bi bi-toggle-on"></i> Activate{% else %}<i class="bi bi-toggle-off"></i> Deactivate{% endif %}
                                </button>
                            {% else %}
                                <button type="button" class="btn {% if not setting.is_active %} btn-success {% else %} btn-warning {% endif %} btn-sm me-1" disabled>
                                    {% if not setting.is_active %}<i class="bi bi-toggle-on"></i> Activate{% else %}<i class="bi bi-toggle-off"></i> Deactivate{% endif %}
                                </button>
                            {% endif %}
                        </form>

                        {% if not setting.is_locked %}
                            <a href="{% url 'finance_salary_setting_update' pk=setting.pk %}" class="btn btn-primary btn-sm me-1">
                                <i class="bi bi-pencil-square"></i> Edit
                            </a>
                        {% else %}
                            <button type="button" class="btn btn-primary btn-sm me-1" disabled><i class="bi bi-pencil-square"></i> Edit</button>
                        {% endif %}

                        <a href="{% url 'finance_salary_setting_list' %}" class="btn btn-danger btn-sm">
                            <i class="bi bi-arrow-left"></i> Back
                        </a>
                    </div>
                </div>
            </div>

            <hr class="mb-4">

            <div class="row g-3 mb-4">
                <div class="col-md-4">
                    <div class="card border-light">
                        <div class="card-body p-3">
                            <h6 class="mb-2"><i class="bi bi-people-fill"></i> Usage</h6>
                            <p class="mb-1"><strong>Staff structures:</strong> {{ usage_stats.structures_count|default:0 }}</p>
                            <p class="mb-1"><strong>Salary records:</strong> {{ usage_stats.records_count|default:0 }}</p>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="card border-light">
                        <div class="card-body p-3">
                            <h6 class="mb-2"><i class="bi bi-person-badge-fill"></i> Meta</h6>
                            <p class="mb-1"><strong>Created by:</strong>
                                {% if setting.created_by %}
                                    {{ setting.created_by.get_full_name|default:setting.created_by.username }}
                                {% else %}
                                    System
                                {% endif %}
                            </p>
                            <p class="mb-1"><strong>Created:</strong> {{ setting.created_at|date:"Y-m-d H:i" }}</p>
                            <p class="mb-0"><strong>Updated:</strong> {{ setting.updated_at|date:"Y-m-d H:i" }}</p>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="card border-light">
                        <div class="card-body p-3">
                            <h6 class="mb-2"><i class="bi bi-gear-fill"></i> Quick Actions</h6>
                            <div class="d-flex gap-2">
                                <button id="downloadJsonBtn" class="btn btn-outline-primary btn-sm"><i class="bi bi-download"></i> Download JSON</button>
                                <button id="copyJsonBtn" class="btn btn-outline-secondary btn-sm"><i class="bi bi-clipboard"></i> Copy JSON</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Salary preview -->
            <div class="card border-light mb-4">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="bi bi-calculator"></i> Salary Preview</h6>
                </div>
                <div class="card-body">
                    <div class="row align-items-end">
                        <div class="col-md-3">
                            <label for="previewSalary" class="form-label">Monthly Salary (₦)</label>
                            <input id="previewSalary" type="number" class="form-control" value="500000" min="0" step="0.01">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Include Leave in Gross</label>
                            {% if setting.include_leave_in_gross %}
                                <div><span class="badge bg-success">Yes</span></div>
                            {% else %}
                                <div><span class="badge bg-secondary">No</span></div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 text-end">
                            <small class="text-muted">Use the preview salary to compute component sample amounts below.</small>
                        </div>
                    </div>
                </div>
            </div>

            {# PUT serialized JSON from view into <script type="application/json"> so JS can parse safely #}
            <script id="basic_components" type="application/json">{{ basic_components_json|safe }}</script>
            <script id="allowances" type="application/json">{{ allowances_json|safe }}</script>
            <script id="reliefs_exemptions" type="application/json">{{ reliefs_json|safe }}</script>
            <script id="tax_brackets" type="application/json">{{ tax_brackets_json|safe }}</script>
            <script id="income_items" type="application/json">{{ income_items_json|safe }}</script>
            <script id="statutory_deductions" type="application/json">{{ statutory_deductions_json|safe }}</script>
            <script id="other_deductions_config" type="application/json">{{ other_deductions_json|safe }}</script>

            <!-- Main JSON / sections -->
            <div class="accordion" id="salarySettingAccordion">

                <!-- Basic Components -->
                <div class="accordion-item mb-3">
                    <h2 class="accordion-header" id="headingBasic">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseBasic" aria-expanded="false" aria-controls="collapseBasic">
                            <i class="bi bi-cash-stack me-2"></i> Basic Salary Components
                        </button>
                    </h2>
                    <div id="collapseBasic" class="accordion-collapse collapse" aria-labelledby="headingBasic" data-bs-parent="#salarySettingAccordion">
                        <div class="accordion-body">
                            <div class="mb-3">
                                <div class="alert alert-info">
                                    These components must total <strong>100%</strong>.
                                    <span class="float-end">Current Total: <strong id="detailTotalPercentage">0.00%</strong></span>
                                </div>
                                <div id="detailBasicComponents" class="row gy-2"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Allowances -->
                <div class="accordion-item mb-3">
                    <h2 class="accordion-header" id="headingAllowances">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAllowances" aria-expanded="false" aria-controls="collapseAllowances">
                            <i class="bi bi-gift me-2"></i> Allowances
                        </button>
                    </h2>
                    <div id="collapseAllowances" class="accordion-collapse collapse" aria-labelledby="headingAllowances" data-bs-parent="#salarySettingAccordion">
                        <div class="accordion-body">
                            <div id="detailAllowances" class="row gy-2"></div>
                        </div>
                    </div>
                </div>

                <!-- Reliefs & Exemptions -->
                <div class="accordion-item mb-3">
                    <h2 class="accordion-header" id="headingReliefs">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseReliefs" aria-expanded="false" aria-controls="collapseReliefs">
                            <i class="bi bi-shield-check me-2"></i> Tax Reliefs & Exemptions
                        </button>
                    </h2>
                    <div id="collapseReliefs" class="accordion-collapse collapse" aria-labelledby="headingReliefs" data-bs-parent="#salarySettingAccordion">
                        <div class="accordion-body">
                            <div id="detailReliefs" class="row gy-2"></div>
                        </div>
                    </div>
                </div>

                <!-- Tax Brackets -->
                <div class="accordion-item mb-3">
                    <h2 class="accordion-header" id="headingBrackets">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseBrackets" aria-expanded="false" aria-controls="collapseBrackets">
                            <i class="bi bi-percent me-2"></i> Tax Brackets (PAYE)
                        </button>
                    </h2>
                    <div id="collapseBrackets" class="accordion-collapse collapse" aria-labelledby="headingBrackets" data-bs-parent="#salarySettingAccordion">
                        <div class="accordion-body">
                            <div id="detailBrackets" class="table-responsive">
                                <table class="table table-striped table-sm">
                                    <thead>
                                        <tr>
                                            <th>Limit (₦)</th>
                                            <th>Rate (%)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="detailBracketsBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Statutory Deductions -->
                <div class="accordion-item mb-3">
                    <h2 class="accordion-header" id="headingStatutory">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseStatutory" aria-expanded="false" aria-controls="collapseStatutory">
                            <i class="bi bi-bank me-2"></i> Statutory Deductions
                        </button>
                    </h2>
                    <div id="collapseStatutory" class="accordion-collapse collapse" aria-labelledby="headingStatutory" data-bs-parent="#salarySettingAccordion">
                        <div class="accordion-body">
                            <div id="detailStatutory" class="row gy-2"></div>
                        </div>
                    </div>
                </div>

                <!-- Other Deductions Config -->
                <div class="accordion-item mb-3">
                    <h2 class="accordion-header" id="headingOther">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOther" aria-expanded="false" aria-controls="collapseOther">
                            <i class="bi bi-dash-circle me-2"></i> Other Deductions Configuration
                        </button>
                    </h2>
                    <div id="collapseOther" class="accordion-collapse collapse" aria-labelledby="headingOther" data-bs-parent="#salarySettingAccordion">
                        <div class="accordion-body">
                            <div id="detailOtherDeductions" class="row gy-2"></div>
                        </div>
                    </div>
                </div>

                <!-- Income Items -->
                <div class="accordion-item mb-3">
                    <h2 class="accordion-header" id="headingIncome">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseIncome" aria-expanded="false" aria-controls="collapseIncome">
                            <i class="bi bi-plus-circle me-2"></i> Additional Income Items
                        </button>
                    </h2>
                    <div id="collapseIncome" class="accordion-collapse collapse" aria-labelledby="headingIncome" data-bs-parent="#salarySettingAccordion">
                        <div class="accordion-body">
                            <div id="detailIncomeItems" class="row gy-2"></div>
                        </div>
                    </div>
                </div>

            </div> <!-- /accordion -->

            <!-- Hidden combined JSON container (for downloading/copying) -->
            <textarea id="combinedJson" class="d-none" readonly>
{{ {
    "name": setting.name,
    "description": setting.description,
    "effective_from": setting.effective_from|stringformat:"s",
    "effective_to": setting.effective_to|stringformat:"s",
    "leave_allowance_percentage": setting.leave_allowance_percentage|stringformat:"s",
    "include_leave_in_gross": setting.include_leave_in_gross|stringformat:"s",
    "basic_components": setting.basic_components,
    "allowances": setting.allowances,
    "reliefs_exemptions": setting.reliefs_exemptions,
    "tax_brackets": setting.tax_brackets,
    "income_items": setting.income_items,
    "statutory_deductions": setting.statutory_deductions,
    "other_deductions_config": setting.other_deductions_config
} | safe }}
            </textarea>

        </div>
    </div>
</div>

<!-- JSON Download Modal (confirmation) -->
<div class="modal fade" id="downloadModal" tabindex="-1" aria-labelledby="downloadModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="downloadModalLabel"><i class="bi bi-download me-2"></i>Download Salary Setting JSON</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Download a JSON file containing this salary setting and its configuration.</p>
        <pre id="downloadJsonPreview" class="small" style="max-height:260px; overflow:auto;"></pre>
      </div>
      <div class="modal-footer">
        <a id="confirmDownloadBtn" class="btn btn-primary" download="salary_setting_{{ setting.pk }}.json"><i class="bi bi-file-earmark-arrow-down"></i> Download</a>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
(function() {

    function readJson(id) {
        const el = document.getElementById(id);
        if (!el) return null;
        try {
            return JSON.parse(el.textContent || 'null');
        } catch (e) {
            console.warn('Failed parsing JSON from', id, e);
            return null;
        }
    }

    const basic = readJson('basic_components') || {};
    const allowances = readJson('allowances') || [];
    const reliefs = readJson('reliefs_exemptions') || [];
    const brackets = readJson('tax_brackets') || [];
    const statutory = readJson('statutory_deductions') || [];
    const otherDeductions = readJson('other_deductions_config') || [];
    const incomeItems = readJson('income_items') || [];

    function fmtMoney(n) {
        try {
            return new Intl.NumberFormat('en-NG', {minimumFractionDigits:2, maximumFractionDigits:2}).format(Number(n));
        } catch(e) {
            return n;
        }
    }

    // BASIC COMPONENTS
    const detailBasicEl = document.getElementById('detailBasicComponents');
    const totalSpan = document.getElementById('detailTotalPercentage');
    function renderBasicComponents(sampleSalary) {
        detailBasicEl.innerHTML = '';
        let total = 0;
        const items = Object.values(basic || {});
        items.forEach(c => {
            const pct = Number(c.percentage || 0);
            total += pct;
            const amount = sampleSalary * pct / 100;
            const col = document.createElement('div');
            col.className = 'col-md-6';
            col.innerHTML = `
                <div class="card border-light">
                    <div class="card-body p-2">
                        <div class="d-flex align-items-start">
                            <div class="me-auto">
                                <strong>${c.name}</strong> <small class="text-muted">(${c.code})</small>
                                <div class="text-muted small">Percentage: ${pct.toFixed(2)}%</div>
                            </div>
                            <div class="text-end">
                                <div class="h6 mb-0">₦${fmtMoney(amount)}</div>
                                <small class="text-muted">Based on ₦${fmtMoney(sampleSalary)}</small>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            detailBasicEl.appendChild(col);
        });
        totalSpan.textContent = total.toFixed(2) + '%';
        totalSpan.className = Math.abs(total - 100) < 0.01 ? 'percentage-valid' : 'percentage-invalid';
    }

    // ALLOWANCES
    const detailAllowances = document.getElementById('detailAllowances');
    function renderAllowances(sampleSalary) {
        detailAllowances.innerHTML = '';
        if (!allowances || allowances.length === 0) {
            detailAllowances.innerHTML = '<p class="text-muted">No allowances configured.</p>';
            return;
        }
        allowances.forEach(a => {
            const col = document.createElement('div');
            col.className = 'col-md-6';
            const isActive = a.is_active ? 'Active' : 'Inactive';
            let rightText = '';
            if (a.calculation_type === 'fixed') {
                rightText = `Fixed: ₦${fmtMoney(a.fixed_amount || 0)}`;
            } else {
                const pct = Number(a.percentage || 0);
                rightText = `${pct.toFixed(2)}% of ${a.based_on || 'TOTAL'}`;
            }
            col.innerHTML = `
                <div class="card border-light">
                    <div class="card-body p-2 d-flex align-items-start">
                        <div class="me-auto">
                            <strong>${a.name}</strong>
                            <div class="small text-muted">${isActive} • ${a.annual_only ? 'Annual only' : 'Monthly'}</div>
                        </div>
                        <div class="text-end small text-muted">${rightText}</div>
                    </div>
                </div>
            `;
            detailAllowances.appendChild(col);
        });
    }

    // RELIEFS
    const detailReliefs = document.getElementById('detailReliefs');
    function renderReliefs() {
        detailReliefs.innerHTML = '';
        if (!reliefs || reliefs.length === 0) {
            detailReliefs.innerHTML = '<p class="text-muted">No reliefs configured.</p>';
            return;
        }
        reliefs.forEach(r => {
            const col = document.createElement('div');
            col.className = 'col-md-6';
            let desc = r.formula_type || '';
            if (r.percentage) desc += ` • ${Number(r.percentage).toFixed(2)}%`;
            if (r.fixed_amount) desc += ` • ₦${fmtMoney(r.fixed_amount)}`;
            if (r.based_on) desc += ` • based on ${r.based_on}`;
            col.innerHTML = `
                <div class="card border-light">
                    <div class="card-body p-2">
                        <strong>${r.name}</strong>
                        <div class="small text-muted">${r.is_active ? 'Active' : 'Inactive'} • ${desc}</div>
                    </div>
                </div>
            `;
            detailReliefs.appendChild(col);
        });
    }

    // TAX BRACKETS
    const detailBracketsBody = document.getElementById('detailBracketsBody');
    function renderBrackets() {
        detailBracketsBody.innerHTML = '';
        if (!brackets || brackets.length === 0) {
            detailBracketsBody.innerHTML = '<tr><td colspan="2" class="text-muted">No tax brackets configured.</td></tr>';
            return;
        }
        brackets.forEach(b => {
            const tr = document.createElement('tr');
            const limitText = (b.limit === null || b.limit === undefined || b.limit === '') ? '<em>Remaining</em>' : '₦' + fmtMoney(b.limit);
            tr.innerHTML = `<td>${limitText}</td><td>${Number(b.rate).toFixed(2)}%</td>`;
            detailBracketsBody.appendChild(tr);
        });
    }

    // STATUTORY DEDUCTIONS
    const detailStatutory = document.getElementById('detailStatutory');
    function renderStatutory(sampleSalary) {
        detailStatutory.innerHTML = '';
        if (!statutory || statutory.length === 0) {
            detailStatutory.innerHTML = '<p class="text-muted">No statutory deductions configured.</p>';
            return;
        }
        // create map code->percentage for basic codes
        const codeMap = {};
        Object.values(basic || {}).forEach(c => { codeMap[c.code] = Number(c.percentage || 0); });

        statutory.forEach(s => {
            const col = document.createElement('div');
            col.className = 'col-md-6';
            const pct = Number(s.percentage || 0);
            const basedOn = s.based_on || 'B';
            // compute sample amount for display
            let amount = 0;
            if (basedOn && typeof basedOn === 'string') {
                const codes = basedOn.split('+').map(x => x.trim());
                let totalPct = 0;
                codes.forEach(code => { totalPct += (codeMap[code] || 0); });
                amount = sampleSalary * (totalPct / 100) * (pct / 100);
            } else {
                amount = sampleSalary * (pct / 100);
            }
            col.innerHTML = `
                <div class="card border-light">
                    <div class="card-body p-2 d-flex align-items-start">
                        <div class="me-auto">
                            <strong>${s.name}</strong>
                            <div class="small text-muted">${s.is_active ? 'Active' : 'Inactive'} • ${pct.toFixed(2)}% of ${basedOn}</div>
                        </div>
                        <div class="text-end">
                            <div class="h6 mb-0">₦${fmtMoney(amount)}</div>
                        </div>
                    </div>
                </div>
            `;
            detailStatutory.appendChild(col);
        });
    }

    // OTHER DEDUCTIONS
    const detailOther = document.getElementById('detailOtherDeductions');
    function renderOtherDeductions() {
        detailOther.innerHTML = '';
        if (!otherDeductions || otherDeductions.length === 0) {
            detailOther.innerHTML = '<p class="text-muted">No other deductions configured.</p>';
            return;
        }
        otherDeductions.forEach(o => {
            const col = document.createElement('div');
            col.className = 'col-md-6';
            const linked = o.linked_to ? ` • linked to ${o.linked_to}` : '';
            col.innerHTML = `
                <div class="card border-light">
                    <div class="card-body p-2">
                        <strong>${o.name}</strong>
                        <div class="small text-muted">${o.display_rule || ''}${linked} • order: ${o.order || 1}</div>
                    </div>
                </div>
            `;
            detailOther.appendChild(col);
        });
    }

    // INCOME ITEMS
    const detailIncome = document.getElementById('detailIncomeItems');
    function renderIncomeItems() {
        detailIncome.innerHTML = '';
        if (!incomeItems || incomeItems.length === 0) {
            detailIncome.innerHTML = '<p class="text-muted">No additional income items configured.</p>';
            return;
        }
        incomeItems.forEach(i => {
            const col = document.createElement('div');
            col.className = 'col-md-6';
            col.innerHTML = `
                <div class="card border-light">
                    <div class="card-body p-2">
                        <strong>${i.name}</strong>
                        <div class="small text-muted">${i.display_rule || ''} • order: ${i.order || 1}</div>
                    </div>
                </div>
            `;
            detailIncome.appendChild(col);
        });
    }

    // Initial render with preview salary
    const salaryInput = document.getElementById('previewSalary');
    let sampleSalary = Number(salaryInput?.value || 500000);
    renderBasicComponents(sampleSalary);
    renderAllowances(sampleSalary);
    renderReliefs();
    renderBrackets();
    renderStatutory(sampleSalary);
    renderOtherDeductions();
    renderIncomeItems();

    // Re-render salary-dependent parts on input change
    if (salaryInput) {
        salaryInput.addEventListener('input', function() {
            sampleSalary = Number(this.value || 0);
            renderBasicComponents(sampleSalary);
            renderAllowances(sampleSalary);
            renderStatutory(sampleSalary);
        });
    }

    // Download & Copy JSON (build combined JSON from parsed pieces + some template fields)
    const downloadBtn = document.getElementById('downloadJsonBtn');
    const downloadModalEl = document.getElementById('downloadModal');
    const downloadModal = downloadModalEl ? new bootstrap.Modal(downloadModalEl) : null;
    const downloadPreview = document.getElementById('downloadJsonPreview');
    const confirmDownloadBtn = document.getElementById('confirmDownloadBtn');

    function buildCombinedJSON() {
        return {
            name: "{{ setting.name|escapejs }}",
            description: "{{ setting.description|default:''|escapejs }}",
            effective_from: "{{ setting.effective_from }}",
            effective_to: "{{ setting.effective_to|default:'' }}",
            leave_allowance_percentage: "{{ setting.leave_allowance_percentage }}",
            include_leave_in_gross: {{ setting.include_leave_in_gross|yesno:"true,false" }},
            basic_components: basic,
            allowances: allowances,
            reliefs_exemptions: reliefs,
            tax_brackets: brackets,
            income_items: incomeItems,
            statutory_deductions: statutory,
            other_deductions_config: otherDeductions
        };
    }

    if (downloadBtn) {
        downloadBtn.addEventListener('click', function() {
            const combined = buildCombinedJSON();
            const pretty = JSON.stringify(combined, null, 2);
            if (downloadPreview) downloadPreview.textContent = pretty;
            if (confirmDownloadBtn) {
                const blob = new Blob([pretty], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                confirmDownloadBtn.setAttribute('href', url);
                confirmDownloadBtn.setAttribute('download', 'salary_setting_{{ setting.pk }}.json');
            }
            if (downloadModal) downloadModal.show();
        });
    }

    const copyBtn = document.getElementById('copyJsonBtn');
    if (copyBtn) {
        copyBtn.addEventListener('click', function() {
            const combined = buildCombinedJSON();
            const text = JSON.stringify(combined, null, 2);
            navigator.clipboard && navigator.clipboard.writeText(text)
                .then(() => {
                    const orig = copyBtn.innerHTML;
                    copyBtn.innerHTML = '<i class="bi bi-clipboard-check"></i> Copied';
                    setTimeout(() => copyBtn.innerHTML = orig, 1500);
                })
                .catch(() => alert('Unable to copy to clipboard. You can download the JSON instead.'));
        });
    }

})();
</script>

<style>
    /* reuse styles from form */
    .percentage-valid { color: #28a745; font-weight:600; }
    .percentage-invalid { color: #dc3545; font-weight:600; }
    .card.border-light { background: #fff; }
</style>

{% endblock %}
