{% extends 'admin_site/layout.html' %}
{% block 'main' %}
{% load humanize %}

<div class="col-lg-10 offset-lg-1 col-md-12">
    <div class="card">
        <div class="card-body">
            <h5 class="card-title">Generate Student Invoices</h5>
            
            <div class="alert alert-info">
                <h6 class="alert-heading">How This Works</h6>
                <p>This tool will generate invoices for all students in the selected classes for the specified session and term. The process runs in the background, so you can safely navigate away from the page after starting.</p>
                <hr>
                <p class="mb-0">The system is smart: it will automatically skip any student who already has an invoice for the selected session and term, preventing duplicate bills.</p>
            </div>

            <form method="POST" class="row g-3">
                {% csrf_token %}

                <!-- Section 1: Session & Term -->
                <div class="col-12 border-bottom pb-3">
                    <h6 class="card-subtitle mb-3 text-muted">Select Billing Period</h6>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.session.id_for_label }}" class="form-label">Academic Session <span class="text-danger">*</span></label>
                            {{ form.session }}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.term.id_for_label }}" class="form-label">Term <span class="text-danger">*</span></label>
                            {{ form.term }}
                        </div>
                    </div>
                </div>

                <!-- Section 2: Class Selection -->
                 <div class="col-12 pt-3">
                    <h6 class="card-subtitle mb-2 text-muted">Select Classes to Invoice <span class="text-danger">*</span></h6>
                     <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="select-all-classes">
                        <label class="form-check-label fw-bold" for="select-all-classes">
                            Select All Classes
                        </label>
                    </div>
                    <hr>
                    <div class="row" style="max-height: 300px; overflow-y: auto;">
                        {% for checkbox in form.classes_to_invoice %}
                            <div class="col-md-4">
                                <div class="form-check">
                                    {{ checkbox.tag }}
                                    <label for="{{ checkbox.id_for_label }}" class="form-check-label">
                                        {{ checkbox.choice_label }}
                                    </label>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                     {% if form.classes_to_invoice.errors %}
                        <div class="invalid-feedback d-block">{{ form.classes_to_invoice.errors.0 }}</div>
                     {% endif %}
                </div>

                <div class="text-start mt-3">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-play-circle-fill"></i> Start Invoice Generation
                    </button>
                    <a href="#" onclick="window.history.back();" class="btn btn-secondary">Cancel</a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const selectAllCheckbox = document.getElementById('select-all-classes');
    const classCheckboxes = document.querySelectorAll('input[name="classes_to_invoice"]');

    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function () {
            classCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
        });
    }
});
</script>
{% endblock %}
