{% extends 'admin_site/layout.html' %}
{% block 'main' %}
{% load humanize %}

<div class="pagetitle">
  <h1>Advance Payment Management</h1>
  <nav>
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="#">Dashboard</a></li>
      <li class="breadcrumb-item"><a href="{% url 'finance_advance_accounts_list' %}">Advance Accounts</a></li>
      <li class="breadcrumb-item active">{{ advance.advance_number }}</li>
    </ol>
  </nav>
</div>

<div class="row">
    <!-- Left Column: Advance Summary -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Advance Summary</h5>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between">
                        <strong>Advance #:</strong> <span>{{ advance.advance_number }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <strong>Staff:</strong> <span>{{ advance.staff.get_full_name|title }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <strong>Request Date:</strong> <span>{{ advance.request_date|date:"d M, Y" }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <strong>Session/Term:</strong> <span>{{ advance.session }} / {{ advance.term.name|title }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <strong>Status:</strong> 
                        <span class="badge 
                            {% if advance.status == 'approved' %}bg-warning
                            {% elif advance.status == 'disbursed' %}bg-primary
                            {% elif advance.status == 'completed' %}bg-success
                            {% else %}bg-secondary{% endif %}">
                            {{ advance.get_status_display }}
                        </span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <strong>Approved Amount:</strong> <h6 class="mb-0">₦{{ advance.approved_amount|floatformat:2|intcomma }}</h6>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <strong>Disbursed Amount:</strong> <span>₦{{ advance.disbursed_amount|floatformat:2|intcomma }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <strong>Balance:</strong> 
                        <h6 class="mb-0 {% if advance.balance > 0 %}text-danger{% else %}text-success{% endif %}">
                            ₦{{ advance.balance|floatformat:2|intcomma }}
                        </h6>
                    </li>
                </ul>
                
                <div class="mt-3">
                    <strong>Purpose:</strong>
                    <p class="text-muted">{{ advance.purpose }}</p>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Actions</h5>
                <a href="{% url 'inventory_advance_detail' advance.pk %}" class="btn btn-sm btn-info">
                    <i class="bi bi-eye"></i> View Advance Details
                </a>
                <a href="{% url 'finance_advance_accounts_list' %}" class="btn btn-sm btn-secondary">Back to List</a>
            </div>
        </div>
    </div>

    <!-- Right Column: Payment Management -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Payment Management</h5>

                {% if advance.balance > 0 %}
                <div class="p-3 mb-3 bg-light rounded border">
                    <h6><i class="bi bi-plus-circle-fill"></i> Record New Payment</h6>
                    <hr>
                    <form method="POST">
                        {% csrf_token %}
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label for="{{ form.amount.id_for_label }}" class="form-label">Amount (₦)</label>
                                {{ form.amount }}
                                <small class="form-text text-muted">{{ form.amount.help_text }}</small>
                                {% if form.amount.errors %}
                                    <div class="invalid-feedback d-block">{{ form.amount.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-3">
                                <label for="{{ form.payment_date.id_for_label }}" class="form-label">Payment Date</label>
                                {{ form.payment_date }}
                            </div>
                            <div class="col-md-3">
                                <label for="{{ form.payment_method.id_for_label }}" class="form-label">Payment Method</label>
                                {{ form.payment_method }}
                            </div>
                            <div class="col-md-3">
                                <label for="{{ form.reference.id_for_label }}" class="form-label">Reference</label>
                                {{ form.reference }}
                            </div>
                            <div class="col-12">
                                <label for="{{ form.notes.id_for_label }}" class="form-label">Notes</label>
                                {{ form.notes }}
                            </div>
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary">Record Payment</button>
                            </div>
                        </div>
                    </form>
                </div>
                {% else %}
                <div class="alert alert-success">
                    <i class="bi bi-check-circle"></i> This advance has been fully disbursed.
                </div>
                {% endif %}

                <h6>Payment History</h6>
                <div class="table-responsive">
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th>Voucher #</th>
                                <th>Date</th>
                                <th>Amount</th>
                                <th>Method</th>
                                <th>Reference</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for payment in payments %}
                            <tr>
                                <td>{{ payment.voucher_number }}</td>
                                <td>{{ payment.payment_date|date:"d M, Y" }}</td>
                                <td>₦{{ payment.amount|floatformat:2|intcomma }}</td>
                                <td>{{ payment.get_payment_method_display }}</td>
                                <td>{{ payment.reference|default:"-" }}</td>
                                <td>{{ payment.notes|default:"-"|truncatechars:50 }}</td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="6" class="text-center">No payments recorded yet.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}


