{% extends 'admin_site/layout.html' %}
{% load static %}
{% load humanize %}
{% block 'main' %}
{% if form.errors %}
        <h5 class="text-danger">{{form.errors}}</h5>
        {% endif %}
<div class="col-lg-12 grid-margin stretch-card">
    <div class="card">
        <div class="card-body">
            <h4 class="card-title">Filter and Search</h4>
            <form>
                <div class="row">
                    <div class="col-3">
                        <label for="session">Session</label>
                        <select id="session" name="session" required class="form-control">
                            <option value="">-------------------</option>
                            {% for session in session_list %}
                            <option {% if academic_info.session.id == session.id %} selected {% endif %} value="{{session.id}}">{{ session }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-3">
                        <label for="term">Term</label>
                        <select id="term" name="term" required class="form-control">
                            <option value="">-------------------</option>
                            {% for term in term_list %}
                            <option {% if academic_info.term.id == term.id %} selected {% endif %} value="{{term.id}}">{{ term }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-4">
                        <label for="search">Search Staff</label>
                        <input type="text" id="search" name="search" class="form-control" value="{{ search_query }}" placeholder="Search by first or last name">
                    </div>

                    <div class="col-2">
                        <label>&nbsp;</label>
                        <div>
                            <input type="submit" value="Filter" class="btn btn-success w-100">
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body pt-3" style="overflow-x:auto">
                <h5 class="card-title">Fee Payments for {{ current_session }} Session - {{ current_term }}
                    {% if search_query %} (Search: "{{ search_query }}"){% endif %}
                </h5>
                <table class="table table-bordered" style="font-size:14px">
                    <thead>
                        <tr>
                            <th scope="col" style="min-width:150px">Staff</th>
                            <th scope="col">Amount Paid</th>
                            <th scope="col" style="">Date</th>
                            <th scope="col" style="">Method</th>
                            <th scope="col">Status</th>
                            <th scope="col" style="" class="text-center">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for payment in fee_payment_list %}
                            <tr>
                                <td scope="row">{{ payment.staff|title }}</td>
                                <td scope="row">{{ payment.amount|intcomma }}</td>
                                <td scope="row">{{ payment.created_at|date }}</td>
                                 <td scope="row">{{ payment.mode|title }} {% if payment.method %} ({{ payment.method|title }}) {% endif %}</td>
                                <td scope="row" {% if payment.status == 'pending' %} class='text-warning' {% elif payment.status == 'declined'  %} class='text-danger' {% else %} class='text-success' {% endif %}>{{ payment.status|title }}</td>
                                <td scope="row" class="text-center">
                                    <a title="View Fee Payment Detail" style="font-size:12px" class="btn btn-primary" href="{% url 'staff_deposit_detail' payment.id %}"><i class="bi bi-eye"></i> </a>
                                    {% if payment.status == 'confirmed' %}
                                        <button
                                            type="button"
                                            class="btn btn-warning btn-revert"
                                            data-toggle="modal"
                                            data-target="#staffRevertModal"
                                            data-funding-id="{{ payment.id }}"
                                            data-funding-amount="{{ payment.amount }}"
                                            data-staff-name="{{ payment.staff|escapejs }}"
                                            title="Revert Funding"
                                            style="font-size:12px">
                                            <i class="bi bi-arrow-counterclockwise"></i>
                                        </button>
                                    {% endif %}
                                </td>
                            </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center">No records found matching your criteria.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

                <!-- Pagination Controls -->
                {% if fee_payment_list.has_other_pages %}
                <nav aria-label="Page navigation">
                    <ul class="pagination justify-content-center">
                        {% if fee_payment_list.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page=1&session={{ current_session.id }}&term={{ current_term.id }}&search={{ search_query|urlencode }}">First</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?page={{ fee_payment_list.previous_page_number }}&session={{ current_session.id }}&term={{ current_term.id }}&search={{ search_query|urlencode }}">Previous</a>
                            </li>
                        {% endif %}

                        <li class="page-item active">
                            <span class="page-link">Page {{ fee_payment_list.number }} of {{ fee_payment_list.paginator.num_pages }}</span>
                        </li>

                        {% if fee_payment_list.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ fee_payment_list.next_page_number }}&session={{ current_session.id }}&term={{ current_term.id }}&search={{ search_query|urlencode }}">Next</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?page={{ fee_payment_list.paginator.num_pages }}&session={{ current_session.id }}&term={{ current_term.id }}&search={{ search_query|urlencode }}">Last</a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}

            </div>
        </div>
    </div>
</div>

<!-- Staff Revert Modal -->
<div class="modal fade" id="staffRevertModal" tabindex="-1" role="dialog" aria-labelledby="staffRevertModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <form id="staffRevertForm" method="post">
      {% csrf_token %}
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="staffRevertModalLabel">Confirm Revert</h5>

        </div>
        <div class="modal-body">
          <p id="staffRevertModalBody">You are about to revert <strong id="staffRevertAmount"></strong> from <strong id="staffRevertStaff"></strong>'s wallet.</p>

          <div class="form-group">
            <label for="staffReasonInput">Reason for Revert <span class="text-danger">*</span></label>
            <textarea id="staffReasonInput" name="reason" class="form-control" required rows="3" placeholder="Provide reason for revert"></textarea>
          </div>

          <input type="hidden" id="staffFundingIdInput" name="funding_id" value="">
        </div>
        <div class="modal-footer">
          <button type="submit" id="staffConfirmRevertBtn" class="btn btn-danger">Proceed with Revert</button>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // Select revert buttons (cover both class names if used)
    const revertButtons = Array.from(document.querySelectorAll('.btn-revert'))
        .concat(Array.from(document.querySelectorAll('.btn-revert-staff')));

    const staffRevertForm = document.getElementById('staffRevertForm');
    const fundingIdInput = document.getElementById('staffFundingIdInput');
    const reasonInput = document.getElementById('staffReasonInput');
    const revertAmountElem = document.getElementById('staffRevertAmount');
    const revertStaffElem = document.getElementById('staffRevertStaff');
    const modalEl = document.getElementById('staffRevertModal');

    if (!modalEl) {
        console.warn('staffRevertModal element not found - modal will not open');
        return;
    }

    // Helper to show the modal for Bootstrap4 (jQuery) or Bootstrap5
    function showModal() {
        // Bootstrap 4 + jQuery
        if (window.jQuery && typeof window.jQuery(modalEl).modal === 'function') {
            window.jQuery(modalEl).modal('show');
            return;
        }

        // Bootstrap 5+
        if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
            const inst = bootstrap.Modal.getOrCreateInstance(modalEl);
            inst.show();
            return;
        }

        // Fallback: make modal visible (basic)
        modalEl.style.display = 'block';
        modalEl.classList.add('show');
    }

    // Helper to hide modal (used optionally after submit)
    function hideModal() {
        if (window.jQuery && typeof window.jQuery(modalEl).modal === 'function') {
            window.jQuery(modalEl).modal('hide');
            return;
        }
        if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
            const inst = bootstrap.Modal.getInstance(modalEl);
            if (inst) inst.hide();
            return;
        }
        modalEl.style.display = 'none';
        modalEl.classList.remove('show');
    }

    // Wire each button to populate modal + show it
    revertButtons.forEach(btn => {
        btn.addEventListener('click', function (e) {
            const fundingId = this.getAttribute('data-funding-id') || '';
            const fundingAmount = this.getAttribute('data-funding-amount') || '';
            const staffName = this.getAttribute('data-staff-name') || '';

            if (fundingIdInput) fundingIdInput.value = fundingId;
            if (revertAmountElem) revertAmountElem.textContent = fundingAmount ? ('â‚¦' + Number(fundingAmount).toLocaleString()) : '';
            if (revertStaffElem) revertStaffElem.textContent = staffName;

            if (staffRevertForm) {
                try {
                    // Django URL trick: replace placeholder 0 with actual id
                    staffRevertForm.action = "{% url 'staff_deposit_revert' 0 %}".replace('/0/', '/' + fundingId + '/');
                } catch (err) {
                    console.warn('Could not set form.action automatically:', err);
                }
            }

            if (reasonInput) reasonInput.value = '';

            showModal();
        });
    });

    // Client-side validation: require reason before allowing the form to submit
    if (staffRevertForm) {
        staffRevertForm.addEventListener('submit', function (e) {
            if (reasonInput && reasonInput.value.trim() === '') {
                e.preventDefault();
                // Focus and show a small message
                reasonInput.focus();
                // Use any flash UI you have, otherwise fallback to alert
                if (typeof toastr !== 'undefined') {
                    toastr.error('Please provide a reason for the revert.');
                } else {
                    alert('Please provide a reason for the revert.');
                }
                return false;
            }
            // Optional: disable submit button to prevent double submits
            const submitBtn = staffRevertForm.querySelector('button[type="submit"]');
            if (submitBtn) submitBtn.disabled = true;
            return true; // allow submit
        });
    }
});
</script>

{%endblock %}