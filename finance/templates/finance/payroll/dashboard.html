{% extends 'admin_site/layout.html' %}
{% load static %}
{% load humanize %}
{% load finance_filters %}

{% block 'main' %}
<style>
.stat-card {
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: transform 0.2s;
}
.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}
.stat-value {
    font-size: 2rem;
    font-weight: bold;
    margin: 10px 0;
}
.stat-label {
    font-size: 0.9rem;
    color: #6c757d;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
.stat-icon {
    font-size: 2.5rem;
    opacity: 0.3;
    position: absolute;
    right: 20px;
    top: 20px;
}
.progress-thin {
    height: 8px;
}
.table-hover tbody tr:hover {
    background-color: #f8f9fa;
}
</style>

<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">{{ page_title }}</h2>
    </div>

    <!-- Month/Year Selector -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-4">
                    <label for="month" class="form-label">Month</label>
                    <select name="month" id="month" class="form-select">
                        {% for m in months %}
                        <option value="{{ m.value }}" {% if m.value == current_month %}selected{% endif %}>
                            {{ m.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="year" class="form-label">Year</label>
                    <select name="year" id="year" class="form-select">
                        {% for y in years %}
                        <option value="{{ y }}" {% if y == current_year %}selected{% endif %}>
                            {{ y }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">&nbsp;</label>
                    <button type="submit" class="btn btn-primary d-block w-100">
                        <i class="bi bi-search"></i> View
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Summary Statistics -->
    <div class="row">
        <!-- Total Staff -->
        <div class="col-md-3">
            <div class="stat-card bg-primary text-white position-relative">
                <i class="bi bi-people-fill stat-icon"></i>
                <div class="stat-label text-white">Total Active Staff</div>
                <div class="stat-value">{{ total_staff }}</div>
            </div>
        </div>

        <!-- Processed -->
        <div class="col-md-3">
            <div class="stat-card bg-success text-white position-relative">
                <i class="bi bi-check-circle-fill stat-icon"></i>
                <div class="stat-label text-white">Processed</div>
                <div class="stat-value">{{ processed_count }}</div>
                <div class="progress progress-thin mt-2">
                    <div class="progress-bar bg-white" role="progressbar" 
                         style="width: {{ processing_completion }}%"></div>
                </div>
                <small>{{ processing_completion|floatformat:1 }}% Complete</small>
            </div>
        </div>

        <!-- Paid -->
        <div class="col-md-3">
            <div class="stat-card bg-info text-white position-relative">
                <i class="bi bi-cash-coin stat-icon"></i>
                <div class="stat-label text-white">Paid</div>
                <div class="stat-value">{{ paid_count }}</div>
                <div class="progress progress-thin mt-2">
                    <div class="progress-bar bg-white" role="progressbar" 
                         style="width: {{ payment_completion }}%"></div>
                </div>
                <small>{{ payment_completion|floatformat:1 }}% of Processed</small>
            </div>
        </div>

        <!-- Pending Payment -->
        <div class="col-md-3">
            <div class="stat-card bg-warning text-dark position-relative">
                <i class="bi bi-hourglass-split stat-icon"></i>
                <div class="stat-label text-white">Pending Payment</div>
                <div class="stat-value">{{ pending_count }}</div>
            </div>
        </div>
    </div>

    <!-- Financial Summary -->
    <div class="row">
        <div class="col-md-12">
            <div class="card mb-4">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="bi bi-cash-stack"></i> Financial Summary</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <span class="text-muted d-block">Total Gross Income</span>
                                <h3 class="text-primary mb-0">₦{{ total_gross|floatformat:2|intcomma }}</h3>
                            </div>
                            <div class="mb-3">
                                <span class="text-muted d-block">Average Gross</span>
                                <h5 class="mb-0">₦{{ avg_gross|floatformat:2|intcomma }}</h5>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <span class="text-muted d-block">Total Net Salary</span>
                                <h3 class="text-success mb-0">₦{{ total_net|floatformat:2|intcomma }}</h3>
                            </div>
                            <div class="mb-3">
                                <span class="text-muted d-block">Average Net</span>
                                <h5 class="mb-0">₦{{ avg_net|floatformat:2|intcomma }}</h5>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <span class="text-muted d-block">Total Deductions</span>
                                <h3 class="text-danger mb-0">₦{{ total_statutory|add:total_tax|add:total_other_deductions|floatformat:2|intcomma }}</h3>
                            </div>
                            <div class="mb-3">
                                <span class="text-muted d-block">Average Tax Rate</span>
                                <h5 class="mb-0">{{ avg_tax_rate|floatformat:2 }}%</h5>
                            </div>
                        </div>
                    </div>

                    <hr>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Statutory Deductions:</span>
                                <strong>₦{{ total_statutory|floatformat:2|intcomma }}</strong>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">PAYE Tax:</span>
                                <strong>₦{{ total_tax|floatformat:2|intcomma }}</strong>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Other Deductions:</span>
                                <strong>₦{{ total_other_deductions|floatformat:2|intcomma }}</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Status -->
    <div class="row">
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="bi bi-wallet2"></i> Payment Status</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span>Amount Paid</span>
                            <strong class="text-success">₦{{ total_amount_paid|floatformat:2|intcomma }}</strong>
                        </div>
                        <div class="progress" style="height: 25px;">
                            <div class="progress-bar bg-success" role="progressbar" 
                                 style="width: {% widthratio total_amount_paid total_net 100 %}%">
                                {% widthratio total_amount_paid total_net 100 %}%
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span>Outstanding</span>
                            <strong class="text-danger">₦{{ total_outstanding|floatformat:2|intcomma }}</strong>
                        </div>
                        <div class="progress" style="height: 25px;">
                            <div class="progress-bar bg-danger" role="progressbar" 
                                 style="width: {% widthratio total_outstanding total_net 100 %}%">
                                {% widthratio total_outstanding total_net 100 %}%
                            </div>
                        </div>
                    </div>

                    <hr>

                    <div class="row text-center">
                        <div class="col-4">
                            <div class="badge bg-success p-3 w-100">
                                <div class="h1 mb-0">{{ paid_count }}</div>
                                <small>Paid</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="badge bg-warning p-3 w-100">
                                <div class="h1 mb-0">{{ partially_paid_count }}</div>
                                <small>Partial</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="badge bg-secondary p-3 w-100">
                                <div class="h1 mb-0">{{ pending_count }}</div>
                                <small>Pending</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top Earners -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="bi bi-trophy"></i> Top 5 Earners</h5>
                </div>
                <div class="card-body">
                    {% if top_earners %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Staff</th>
                                    <th class="text-end">Net Salary</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for record in top_earners %}
                                <tr>
                                    <td>
                                        <strong>{{ record.staff }}</strong><br>
                                        <small class="text-muted">{{ record.staff.staff_id }}</small>
                                    </td>
                                    <td class="text-end">
                                        <strong class="text-success">₦{{ record.net_salary|floatformat:2|intcomma }}</strong>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted text-center py-3">No records available</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Payments & Unprocessed Staff -->
    <div class="row">
        <!-- Recent Payments -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-clock-history"></i> Recent Payments</h5>
                </div>
                <div class="card-body">
                    {% if recent_payments %}
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Staff</th>
                                    <th>Amount</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for record in recent_payments %}
                                <tr>
                                    <td>
                                        <strong>{{ record.staff }}</strong><br>
                                        <small class="text-muted">{{ record.staff.staff_id }}</small>
                                    </td>
                                    <td>₦{{ record.amount_paid|floatformat:2|intcomma }}</td>
                                    <td>{{ record.paid_date|date:"M d, Y" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted text-center py-3">No recent payments</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Unprocessed Staff -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header bg-warning">
                    <h5 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Unprocessed Staff ({{ unprocessed_count }})</h5>
                </div>
                <div class="card-body">
                    {% if unprocessed_staff %}
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Staff</th>
                                    <th>Monthly Salary</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for structure in unprocessed_staff %}
                                <tr>
                                    <td>
                                        <strong>{{ structure.staff }}</strong><br>
                                        <small class="text-muted">{{ structure.staff.staff_id }}</small>
                                    </td>
                                    <td>₦{{ structure.monthly_salary|floatformat:2|intcomma }}</td>
                                    <td>
                                        <a href="{% url 'finance_process_payroll' structure.id %}?year={{ current_year }}&month={{ current_month }}" 
                                           class="btn btn-sm btn-primary">
                                            <i class="bi bi-play-fill"></i> Process
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% if unprocessed_count > 10 %}
                    <div class="text-center mt-3">
                        <small class="text-muted">Showing 10 of {{ unprocessed_count }} unprocessed staff</small>
                    </div>
                    {% endif %}
                    {% else %}
                    <div class="alert alert-success mb-0">
                        <i class="bi bi-check-circle"></i> All staff have been processed for this month!
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- All Records -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-file-earmark-text"></i> All Payroll Records ({{ processed_count }})</h5>

        </div>
        <div class="card-body">
            {% if records %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Staff</th>
                            <th>Staff ID</th>
                            <th class="text-end">Gross Income</th>
                            <th class="text-end">Deductions</th>
                            <th class="text-end">Net Salary</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for record in records %}
                        <tr>
                            <td>
                                <strong>{{ record.staff }}</strong><br>
                                <small class="text-muted">{{ record.staff.department|default:"N/A" }}</small>
                            </td>
                            <td>{{ record.staff.staff_id }}</td>
                            <td class="text-end">₦{{ record.total_income|floatformat:2|intcomma }}</td>
                            <td class="text-end">₦{{ record.total_statutory_deductions|add:record.monthly_tax|add:record.total_other_deductions|floatformat:2|intcomma }}</td>
                            <td class="text-end">
                                <strong class="text-success">₦{{ record.net_salary|floatformat:2|intcomma }}</strong>
                            </td>
                            <td>
                                {% if record.payment_status == 'paid' %}
                                    <span class="badge bg-success">Paid</span>
                                {% elif record.payment_status == 'partially_paid' %}
                                    <span class="badge bg-warning">Partial</span>
                                {% else %}
                                    <span class="badge bg-secondary">Pending</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <a href="{% url 'finance_salary_record_detail' record.pk %}" 
                                       class="btn btn-outline-primary" title="View">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    <a href="{% url 'finance_process_payroll' record.salary_structure.id %}?year={{ current_year }}&month={{ current_month }}" 
                                       class="btn btn-outline-secondary" title="Edit">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    {% if record.payment_status != 'paid' %}
                                    <a href="{% url 'finance_mark_as_paid' record.pk %}" 
                                       class="btn btn-outline-success" title="Mark as Paid">
                                        <i class="bi bi-check-circle"></i>
                                    </a>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-info mb-0">
                <i class="bi bi-info-circle"></i> No payroll records found for {{ month_name }} {{ current_year }}.
                {% if unprocessed_staff %}
                Start by processing the unprocessed staff above.
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}