{% extends 'admin_site/layout.html' %}
{% block 'main' %}
{% load humanize %}

<div class="col-12">
    <div class="card overflow-auto">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="card-title">Fee Types</h5>
                <div>
                    <button class="btn btn-sm btn-info text-white" data-bs-toggle="modal" data-bs-target="#feeHelperModal"><b><i class="bi bi-question-circle"></i> Helper</b></button>
                    <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addFeeModal">
                        <i class="bi bi-plus-circle"></i> Add Fee Type
                    </button>
                </div>
            </div>
            <p class="card-description">
                Define the individual types of fees the school charges (e.g., Tuition, PTA Levy).
            </p>

            <table class="table table-hover">
                <thead>
                <tr>
                    <th>#</th>
                    <th>Name</th>
                    <th>Code</th>
                    <th>Occurrence</th>
                    <th class="text-center">Action</th>
                </tr>
                </thead>
                <tbody>
                {% for fee in fees %}
                <tr>
                    <th scope="row">{{ forloop.counter }}</th>
                    <td>{{ fee.name|title }}</td>
                    <td>{{ fee.code|upper }}</td>
                    <td>{{ fee.get_occurrence_display }}</td>
                    <td class="text-center">
                        <button title="Edit Fee" type="button" class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#editFeeModal{{ fee.pk }}"><i class="bi bi-pencil-square"></i></button>
                        <a title="Delete Fee" href="{% url 'finance_fee_delete' fee.pk %}" class="btn btn-sm btn-danger"><i class="bi bi-trash"></i></a>
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
            {% if not fees %}
                 <div class="alert alert-secondary text-center" role="alert">
                    No fee types have been added yet.
                 </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Fee Helper Modal -->
<div class="modal fade" id="feeHelperModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><b>Fee Types Helper</b></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p><strong>Fee Types</strong> are the building blocks of your school's billing system. Each one represents a specific charge that can be assigned to students.</p>
                <ul>
                    <li><strong>Name:</strong> The descriptive name (e.g., "First Term Tuition Fee").</li>
                    <li><strong>Code:</strong> A short, unique code for easy reference (e.g., "TUI-01").</li>
                    <li><strong>Occurrence:</strong> How often the fee is charged (Termly, Annually, or a One Time fee).</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Add New Fee Modal -->
<form method="POST" action="{% url 'finance_fee_create' %}">
    {% csrf_token %}
    <div class="modal fade" id="addFeeModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title"><b>Add New Fee Type</b></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-8"><label class="form-label">Name</label>{{ form.name }}</div>
                        <div class="col-md-4"><label class="form-label">Code</label>{{ form.code }}</div>
                        <div class="col-md-6"><label class="form-label">Occurrence</label>{{ form.occurrence }}</div>
                        <div class="col-md-6"><label class="form-label">Payment Term (for One Time fees)</label>{{ form.payment_term }}</div>
                        <div class="col-12"><label class="form-label">Description</label>{{ form.description }}</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Fee Type</button>
                </div>
            </div>
        </div>
    </div>
</form>

<!-- Edit Fee Modals -->
{% for fee in fees %}
<form method="POST" action="{% url 'finance_fee_update' fee.pk %}">
    {% csrf_token %}
    <div class="modal fade" id="editFeeModal{{ fee.pk }}" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title"><b>Edit Fee Type</b></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                     <div class="row g-3">
                        <div class="col-md-8"><label class="form-label">Name</label><input type="text" name="name" value="{{ fee.name }}" class="form-control" required></div>
                        <div class="col-md-4"><label class="form-label">Code</label><input type="text" name="code" value="{{ fee.code }}" class="form-control" required></div>
                        <div class="col-md-6"><label class="form-label">Occurrence</label>
                            <select name="occurrence" class="form-select">
                                {% for value, label in form.fields.occurrence.choices %}
                                <option value="{{ value }}" {% if fee.occurrence == value %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6"><label class="form-label">Payment Term</label>
                             <select name="payment_term" class="form-select">
                                 <option value="">---------</option>
                                {% for term in form.fields.payment_term.queryset %}
                                <option value="{{ term.pk }}" {% if fee.payment_term.pk == term.pk %}selected{% endif %}>{{ term.name|title }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-12"><label class="form-label">Description</label><textarea name="description" class="form-control" rows="3">{{ fee.description|default:"" }}</textarea></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </div>
        </div>
    </div>
</form>
{% endfor %}
{% endblock %}
