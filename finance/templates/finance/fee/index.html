{% extends 'admin_site/layout.html' %}
{% block 'main' %}
{% load static %}
{% load humanize %}

<div class="col-12">
    <div class="card overflow-auto">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="card-title">Fee Types</h5>
                <div>
                    <button class="btn btn-sm btn-info text-white" data-bs-toggle="modal" data-bs-target="#feeHelperModal"><b><i class="bi bi-question-circle"></i> Helper</b></button>
                    <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addFeeModal">
                        <i class="bi bi-plus-circle"></i> Add Fee Type
                    </button>
                </div>
            </div>
            <p class="card-description">
                Define the individual types of fees the school charges (e.g., Tuition, PTA Levy).
            </p>

            <table class="table table-hover">
                <thead>
                <tr>
                    <th>#</th>
                    <th>Name</th>
                    <th>Code</th>
                    <th>Occurrence</th>
                    <th>Utility</th>
                    <th>Parent Bound</th>
                    <th>Quarter</th>
                    <th class="text-center">Action</th>
                </tr>
                </thead>
                <tbody>
                {% for fee in fees %}
                <tr>
                    <th scope="row">{{ forloop.counter }}</th>
                    <td>{{ fee.name|title }}</td>
                    <td>{{ fee.code|upper }}</td>
                    <td>{{ fee.get_occurrence_display }}</td>
                    <td>{{ fee.required_utility.name|default:"---" }}</td>
                    <td class="text-center">
                        {% if fee.parent_bound %}
                            <i class="bi bi-person-fill text-primary" title="Parent Bound"></i>
                        {% else %}
                            <i class="bi bi-person text-secondary" title="Student Bound"></i>
                        {% endif %}
                    </td>
                    <td>{% if fee.occurrence == 'termly' %} All {% else %} {{ fee.payment_term }} {% endif %}</td>

                    <td class="text-center">
                        <button title="Edit Fee" type="button" class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#editFeeModal{{ fee.pk }}"><i class="bi bi-pencil-square"></i></button>
                        <a title="Delete Fee" href="{% url 'finance_fee_delete' fee.pk %}" class="btn btn-sm btn-danger"><i class="bi bi-trash"></i></a>
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
            {% if not fees %}
                 <div class="alert alert-secondary text-center" role="alert">
                    No fee types have been added yet.
                 </div>
            {% endif %}
        </div>
    </div>
</div>

<div class="modal fade" id="feeHelperModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><b><i class="bi bi-info-circle me-2"></i>Fee Types Helper</b></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p><strong>Fee Types</strong> are the building blocks of your school's billing system. Each one represents a specific charge that can be assigned to students.</p>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex align-items-center">
                        <i class="bi bi-fonts fs-4 text-primary me-3"></i>
                        <div>
                            <strong>Name:</strong>
                            <p class="mb-0 text-muted small">The descriptive name (e.g., "First Term Tuition Fee").</p>
                        </div>
                    </li>
                    <li class="list-group-item d-flex align-items-center">
                        <i class="bi bi-journal-code fs-4 text-primary me-3"></i>
                        <div>
                            <strong>Code:</strong>
                            <p class="mb-0 text-muted small">A short, unique code for easy reference (e.g., "TUI-01").</p>
                        </div>
                    </li>
                    <li class="list-group-item d-flex align-items-center">
                        <i class="bi bi-arrow-repeat fs-4 text-primary me-3"></i>
                        <div>
                            <strong>Occurrence:</strong>
                            <p class="mb-0 text-muted small">How often the fee is charged: Termly, Annually, or One Time.</p>
                        </div>
                    </li>
                    <li class="list-group-item d-flex align-items-center">
                         <i class="bi bi-calendar-check fs-4 text-primary me-3"></i>
                         <div>
                            <strong>Payment Quarter:</strong>
                            <p class="mb-0 text-muted small">For <strong>Annually</strong> or <strong>One Time</strong> fees, specifies which term the fee should be billed in.</p>
                         </div>
                    </li>
                </ul>
            </div>
             <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<form method="POST" action="{% url 'finance_fee_create' %}">
    {% csrf_token %}
    <div class="modal fade" id="addFeeModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title"><b>Add New Fee Type</b></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-8"><label class="form-label">Name</label>{{ form.name }}</div>
                        <div class="col-md-4"><label class="form-label">Code</label>{{ form.code }}</div>
                        <div class="col-md-6"><label class="form-label">Occurrence</label>{{ form.occurrence }}</div>

                        <div class="col-md-6 d-none" id="add_payment_term_div">
                            <label class="form-label">Payment Quarter</label>
                            {{ form.payment_term }}
                            <div class="form-text">Required for Annually or One Time fees.</div>
                        </div>

                        <div class="col-md-6"><label class="form-label">Required Utility (Optional)</label>{{ form.required_utility }}</div>

                        <div class="col-md-6 d-flex align-items-center">
                            <div class="form-check pt-4">
                                {{ form.parent_bound }}
                                <label class="form-check-label" for="id_parent_bound">Charge once per Parent/Family</label>
                            </div>
                        </div>

                        <div class="col-12"><label class="form-label">Description</label>{{ form.description }}</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Fee Type</button>
                </div>
            </div>
        </div>
    </div>
</form>

{% for fee in fees %}
<form method="POST" action="{% url 'finance_fee_update' fee.pk %}">
    {% csrf_token %}
    <div class="modal fade" id="editFeeModal{{ fee.pk }}" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title"><b>Edit Fee Type</b></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                     <div class="row g-3">
                        <div class="col-md-8"><label class="form-label">Name</label><input type="text" name="name" value="{{ fee.name }}" class="form-control" required></div>
                        <div class="col-md-4"><label class="form-label">Code</label><input type="text" name="code" value="{{ fee.code }}" class="form-control" required></div>
                        <div class="col-md-6"><label class="form-label">Occurrence</label>
                            <select name="occurrence" class="form-select occurrence-select">
                                {% for value, label in form.fields.occurrence.choices %}
                                <option value="{{ value }}" {% if fee.occurrence == value %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-6 payment-term-div">
                             <label class="form-label">Payment Quarter</label>
                             <select name="payment_term" class="form-select payment-term-select">
                                 <option value="">---------</option>
                                {% for term in form.fields.payment_term.queryset %}
                                <option value="{{ term.pk }}" {% if fee.payment_term.pk == term.pk %}selected{% endif %}>{{ term.name|title }}</option>
                                {% endfor %}
                            </select>
                            <div class="form-text">Required for Annually or One Time fees.</div>
                        </div>

                         <div class="col-md-6">
                            <label class="form-label">Required Utility (Optional)</label>
                            <select name="required_utility" class="form-select">
                                <option value="">---------</option>
                                {% for utility in form.fields.required_utility.queryset %}
                                <option value="{{ utility.pk }}" {% if fee.required_utility.pk == utility.pk %}selected{% endif %}>{{ utility.name|title }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-6 d-flex align-items-center">
                            <div class="form-check pt-4">
                                <input type="checkbox" name="parent_bound" class="form-check-input" id="id_parent_bound_edit_{{ fee.pk }}" {% if fee.parent_bound %}checked{% endif %}>
                                <label class="form-check-label" for="id_parent_bound_edit_{{ fee.pk }}">Charge once per Parent/Family</label>
                            </div>
                        </div>

                        <div class="col-12"><label class="form-label">Description</label><textarea name="description" class="form-control" rows="3">{{ fee.description|default:"" }}</textarea></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </div>
        </div>
    </div>
</form>
{% endfor %}
<script src="{% static 'admin_site/scripts/jquery.js' %}"></script>
<script>
$(document).ready(function(){

    // --- Logic for ADD FEE modal ---
    function toggleAddPaymentTerm() {
        // Django's default form field ID is "id_<field_name>"
        // Assuming your model values are 'annually' and 'one_time'
        const occurrence = $('#id_occurrence').val();
        const paymentTermDiv = $('#add_payment_term_div');
        const paymentTermSelect = $('#id_payment_term');

        if (occurrence === 'annually' || occurrence === 'one_time') {
            paymentTermDiv.removeClass('d-none');
            paymentTermSelect.prop('required', true);
        } else {
            paymentTermDiv.addClass('d-none');
            paymentTermSelect.prop('required', false);
            paymentTermSelect.val(''); // Clear the selection when hiding
        }
    }

    // Attach event listener for the "Add Fee" modal's occurrence dropdown
    $('#id_occurrence').on('change', toggleAddPaymentTerm);


    // --- Logic for EDIT FEE modals ---
    function toggleEditPaymentTerm(occurrenceSelectElement) {
        const occurrence = $(occurrenceSelectElement).val();
        // Find the related elements within the same modal form
        const modalBody = $(occurrenceSelectElement).closest('.modal-body');
        const paymentTermDiv = modalBody.find('.payment-term-div');
        const paymentTermSelect = modalBody.find('.payment-term-select');

        if (occurrence === 'annually' || occurrence === 'one_time') {
            paymentTermDiv.removeClass('d-none');
            paymentTermSelect.prop('required', true);
        } else {
            paymentTermDiv.addClass('d-none');
            paymentTermSelect.prop('required', false);
            paymentTermSelect.val(''); // Clear the selection when hiding
        }
    }

    // Attach event listener for all "Edit Fee" modals' occurrence dropdowns
    $('.occurrence-select').on('change', function() {
        toggleEditPaymentTerm(this);
    });

    // --- Set Initial State on Page Load ---
    // Run the function for each "Edit Fee" modal to set the correct initial visibility
    $('.occurrence-select').each(function() {
        toggleEditPaymentTerm(this);
    });

    // Set initial state for the "Add Fee" modal (it should be hidden by default)
    toggleAddPaymentTerm();

});
</script>

{% endblock %}