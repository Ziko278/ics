{% extends 'admin_site/layout.html' %}
{% load static %}

{% block 'main' %}
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Collection Generation Job Status</h5>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <p><strong>Job ID:</strong> {{ job.job_id }}</p>
                        <p><strong>Assignment:</strong> {{ job.assignment.item.name }}</p>
                        <p><strong>Session/Term:</strong> {{ job.assignment.session.name }} - {{ job.assignment.term.name }}</p>
                        <p><strong>Created:</strong> {{ job.created_at|date:"d M Y, H:i" }}</p>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Status:</label>
                            <h4>
                                <span id="job-status" class="badge 
                                    {% if job.status == 'pending' %}bg-secondary
                                    {% elif job.status == 'in_progress' %}bg-primary
                                    {% elif job.status == 'success' %}bg-success
                                    {% elif job.status == 'failure' %}bg-danger
                                    {% endif %}">
                                    {{ job.get_status_display }}
                                </span>
                            </h4>
                        </div>
                    </div>
                </div>

                <!-- Progress Bar -->
                <div class="mb-4">
                    <label class="form-label">Progress:</label>
                    <div class="progress" style="height: 30px;">
                        <div id="progress-bar" 
                             class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" 
                             style="width: {{ job.progress_percentage }}%">
                            <span id="progress-text">{{ job.progress_percentage }}%</span>
                        </div>
                    </div>
                </div>

                <!-- Statistics -->
                <div class="row text-center mb-4">
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h3 id="total-students">{{ job.total_students }}</h3>
                                <p class="text-muted mb-0">Total Students</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h3 id="processed-students">{{ job.processed_students }}</h3>
                                <p class="text-muted mb-0">Processed</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body">
                                <h3 id="created-collections">{{ job.created_collections }}</h3>
                                <p class="mb-0">Created</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-warning">
                            <div class="card-body">
                                <h3 id="skipped-students">{{ job.skipped_students }}</h3>
                                <p class="mb-0">Skipped (Duplicate)</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Error Message -->
                <div id="error-container" style="display: {% if job.error_message %}block{% else %}none{% endif %};">
                    <div class="alert alert-danger">
                        <h6><i class="bi bi-exclamation-triangle"></i> Error:</h6>
                        <p id="error-message">{{ job.error_message }}</p>
                    </div>
                </div>

                <!-- Completion Info -->
                <div id="completion-info" style="display: {% if job.completed_at %}block{% else %}none{% endif %};">
                    <div class="alert alert-info">
                        <p class="mb-1"><strong>Started:</strong> <span id="started-at">{{ job.started_at|date:"d M Y, H:i:s" }}</span></p>
                        <p class="mb-1"><strong>Completed:</strong> <span id="completed-at">{{ job.completed_at|date:"d M Y, H:i:s" }}</span></p>
                        {% if job.duration %}
                        <p class="mb-0"><strong>Duration:</strong> <span id="duration">{{ job.duration|floatformat:2 }} seconds</span></p>
                        {% endif %}
                    </div>
                </div>

                <!-- Actions -->
                <div class="mt-4">
                    {% if job.status == 'success' %}
                    <a href="{% url 'student_collection_search' %}" class="btn btn-primary">
                        <i class="bi bi-people"></i> Manage Student Collections
                    </a>
                    {% endif %}
                    <a href="{% url 'assignment_list' %}" class="btn btn-secondary">
                        <i class="bi bi-arrow-left"></i> Back to Assignments
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Auto-refresh job status if still in progress
{% if job.status == 'pending' or job.status == 'in_progress' %}
let refreshInterval = setInterval(function() {
    fetch('{% url "collection_job_status_ajax" job.job_id %}')
        .then(response => response.json())
        .then(data => {
            // Update status badge
            const statusBadge = document.getElementById('job-status');
            statusBadge.textContent = data.status.replace('_', ' ').toUpperCase();
            statusBadge.className = 'badge ';
            
            if (data.status === 'pending') {
                statusBadge.className += 'bg-secondary';
            } else if (data.status === 'in_progress') {
                statusBadge.className += 'bg-primary';
            } else if (data.status === 'success') {
                statusBadge.className += 'bg-success';
            } else if (data.status === 'failure') {
                statusBadge.className += 'bg-danger';
            }

            // Update progress bar
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            progressBar.style.width = data.progress_percentage + '%';
            progressText.textContent = data.progress_percentage + '%';

            // Update statistics
            document.getElementById('total-students').textContent = data.total_students;
            document.getElementById('processed-students').textContent = data.processed_students;
            document.getElementById('created-collections').textContent = data.created_collections;
            document.getElementById('skipped-students').textContent = data.skipped_students;

            // Show error if exists
            if (data.error_message) {
                document.getElementById('error-container').style.display = 'block';
                document.getElementById('error-message').textContent = data.error_message;
            }

            // Stop polling if job is complete
            if (data.status === 'success' || data.status === 'failure') {
                clearInterval(refreshInterval);
                progressBar.classList.remove('progress-bar-animated');
                
                // Show completion info
                document.getElementById('completion-info').style.display = 'block';
                
                // Reload page to show final state
                setTimeout(function() {
                    location.reload();
                }, 2000);
            }
        })
        .catch(error => {
            console.error('Error fetching job status:', error);
        });
}, 2000); // Poll every 2 seconds
{% endif %}
</script>
{% endblock %}