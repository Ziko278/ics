{% extends 'admin_site/layout.html' %}
{% load static %}

{% block 'main' %}
<div class="card">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="card-title mb-0">Inventory Level Report</h4>
        </div>

        <!-- Filter Form -->
        <form method="GET" id="reportForm" class="mb-4">
            <div class="row g-3">
                <!-- Date Range -->
                <div class="col-md-3">
                    <label class="form-label small">From Date</label>
                    <input type="date" name="date_from" class="form-control" value="{{ date_from }}" required>
                </div>
                <div class="col-md-3">
                    <label class="form-label small">To Date</label>
                    <input type="date" name="date_to" class="form-control" value="{{ date_to }}" required>
                </div>

                <!-- Location Filter -->
                <div class="col-md-2">
                    <label class="form-label small">Location</label>
                    <select name="location" class="form-select">
                        <option value="all" {% if location_filter == 'all' %}selected{% endif %}>All</option>
                        <option value="shop" {% if location_filter == 'shop' %}selected{% endif %}>Shop</option>
                        <option value="store" {% if location_filter == 'store' %}selected{% endif %}>Store</option>
                    </select>
                </div>

                <!-- Sort By -->
                <div class="col-md-2">
                    <label class="form-label small">Sort By</label>
                    <select name="sort_by" class="form-select">
                        <option value="category" {% if sort_by == 'category' %}selected{% endif %}>Category & Name</option>
                        <option value="name" {% if sort_by == 'name' %}selected{% endif %}>Name Only</option>
                    </select>
                </div>

                <!-- Apply Button -->
                <div class="col-md-2">
                    <label class="form-label small">&nbsp;</label>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-filter"></i> Apply
                    </button>
                </div>
            </div>

            <!-- Additional Options Row -->
            <div class="row g-3 mt-2">
                <div class="col-md-12">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" name="skip_zero" id="skipZero"
                               value="on" {% if skip_zero %}checked{% endif %}>
                        <label class="form-check-label" for="skipZero">
                            Skip items with no activity
                        </label>
                    </div>

                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" name="show_optional" id="showOptional"
                               value="on" {% if show_optional %}checked{% endif %}>
                        <label class="form-check-label" for="showOptional">
                            Show Qty Sold & Stocked Out
                        </label>
                    </div>

                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" name="include_school_info" id="includeSchoolInfo"
                               value="on" {% if include_school_info %}checked{% endif %}>
                        <label class="form-check-label" for="includeSchoolInfo">
                            Include school info in PDF
                        </label>
                    </div>
                </div>
            </div>
        </form>

        <!-- PDF Download Button -->
        <div class="mb-3 text-end">
            <button onclick="downloadPDF()" class="btn btn-danger">
                <i class="fas fa-file-pdf"></i> Download PDF
            </button>
        </div>

        <!-- Report Title -->
        <div class="text-center mb-4">
            <h5 class="text-primary">{{ report_title }}</h5>
            <p class="text-muted mb-0">
                Location: <strong>{{ location_filter|title }}</strong> |
                Sorted by: <strong>{% if sort_by == 'category' %}Category & Name{% else %}Name Only{% endif %}</strong>
            </p>
        </div>

        <!-- Inventory Table -->
        <div class="table-responsive">
            <table class="table table-striped table-hover table-sm">
                <thead class="table-dark">
                    <tr>
                        <th class="text-center" style="width: 50px;">S/N</th>
                        <th>Product Name</th>
                        <th>Category</th>
                        <th class="text-end">Qty Stocked In</th>
                        {% if show_optional %}
                        <th class="text-end">Qty Sold</th>
                        <th class="text-end">Qty Stocked Out</th>
                        {% endif %}
                        <th class="text-end">Qty Left</th>
                    </tr>
                </thead>
                <tbody>
                    {% for data in inventory_data %}
                    <tr>
                        <td class="text-center">{{ forloop.counter }}</td>
                        <td>
                            <a href="{% url 'inventory_item_detail' data.item.pk %}" class="text-decoration-none">
                                {{ data.item.name }}
                            </a>
                            <small class="text-muted d-block">{{ data.item.get_unit_display }}</small>
                        </td>
                        <td>
                            <span class="badge bg-secondary">{{ data.category }}</span>
                        </td>
                        <td class="text-end">{{ data.qty_stocked_in|floatformat:2 }}</td>
                        {% if show_optional %}
                        <td class="text-end text-danger">{{ data.qty_sold|floatformat:2 }}</td>
                        <td class="text-end text-warning">{{ data.qty_stocked_out|floatformat:2 }}</td>
                        {% endif %}
                        <td class="text-end">
                            <strong class="text-primary">{{ data.qty_left|floatformat:2 }}</strong>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="{% if show_optional %}7{% else %}5{% endif %}" class="text-center py-4">
                            <div class="text-muted">
                                <i class="fas fa-box-open fa-2x mb-2"></i>
                                <br>
                                No inventory data found for the selected criteria.
                                {% if skip_zero %}
                                <br>
                                <small>Try unchecking "Skip items with no activity"</small>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Summary Info -->
        {% if inventory_data %}
        <div class="alert alert-info mt-3">
            <i class="fas fa-info-circle"></i>
            <strong>Legend:</strong>
            <ul class="mb-0 mt-2">
                <li><strong>Qty Stocked In:</strong> New stock received during the selected period</li>
                {% if show_optional %}
                <li><strong>Qty Sold:</strong> Quantity sold during the selected period</li>
                <li><strong>Qty Stocked Out:</strong> Quantity removed (damage, wastage, etc.) during the selected period</li>
                {% endif %}
                <li><strong>Qty Left:</strong> Current stock level in the system (as of today)</li>
            </ul>
        </div>
        {% endif %}
    </div>
</div>

<script>
function downloadPDF() {
    const form = document.getElementById('reportForm');

    // Add download parameter
    const downloadInput = document.createElement('input');
    downloadInput.type = 'hidden';
    downloadInput.name = 'download';
    downloadInput.value = 'pdf';
    form.appendChild(downloadInput);

    // Submit form
    form.submit();

    // Remove download parameter after a brief delay
    setTimeout(() => {
        form.removeChild(downloadInput);
    }, 100);
}
</script>

<style>
.table th {
    font-size: 0.85rem;
    white-space: nowrap;
}

.table td {
    font-size: 0.875rem;
    vertical-align: middle;
}

.form-check-inline {
    margin-right: 1.5rem;
}

.badge {
    font-weight: normal;
}
</style>
{% endblock %}