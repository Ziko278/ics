{% extends 'admin_site/layout.html' %}
{% load static humanize %}

{% block 'main' %}
<style>
    /* Suggestions dropdown styles */
    .suggestions-container {
        position: relative;
        z-index: 8;
    }
    .suggestions-list {
        position: absolute; z-index: 1050; width: 100%;
        max-height: 250px; overflow-y: auto;
        background: #fff; border: 1px solid #ddd;
        border-radius: 0 0 0.25rem 0.25rem;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        z-index:200;
    }
    .suggestion-item { cursor: pointer; z-index:200}
    .suggestion-item:hover { background-color: #f8f9fa; }
    .table-responsive {
        overflow: visible;
    }

    /* Type badges for student/staff */
    .type-badge {
        font-size: 0.7rem;
        padding: 2px 6px;
        border-radius: 3px;
        margin-right: 5px;
    }
    .type-student { background-color: #0d6efd; color: white; }
    .type-staff { background-color: #198754; color: white; }

    /* Top items list */
    .top-item-badge {
        cursor: pointer;
        transition: all 0.2s ease-in-out;
    }
    .top-item-badge:hover {
        transform: translateY(-2px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    /* Fingerprint scanner status */
    .fingerprint-status {
        position: fixed;
        top: 80px;
        right: 20px;
        z-index: 1000;
        background: white;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        padding: 12px 16px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        min-width: 280px;
    }

    .scanner-pulse {
        animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    /* Scan overlay */
    .scan-overlay {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 9999;
        display: none;
        align-items: center;
        justify-content: center;
    }

    .scan-overlay.active {
        display: flex;
    }

    .scan-message {
        background: white;
        padding: 40px;
        border-radius: 12px;
        text-align: center;
        max-width: 400px;
    }
</style>

<div class="card">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="card-title mb-0">POINT OF SALE</h3>
            <button type="button" class="btn btn-outline-primary btn-sm" id="toggle-fingerprint-scanner">
                <i class="bi bi-fingerprint"></i> Enable Fingerprint Scanner
            </button>
        </div>

        <!-- Fingerprint Scanner Status (Hidden by default) -->
        <div class="fingerprint-status" id="fingerprint-status" style="display: none;">
            <div class="d-flex align-items-center">
                <div id="fp-status-icon" class="me-2">
                    <i class="bi bi-question-circle text-warning"></i>
                </div>
                <div>
                    <strong id="fp-status-text" class="d-block" style="font-size: 0.9rem;">Initializing...</strong>
                    <small id="fp-status-detail" class="text-muted">Checking scanner...</small>
                </div>
            </div>
            <button type="button" class="btn btn-danger btn-sm w-100 mt-2" id="stop-fingerprint-scanner">
                <i class="bi bi-stop-circle"></i> Stop Scanner
            </button>
        </div>

        <!-- Scan Overlay -->
        <div class="scan-overlay" id="scan-overlay">
            <div class="scan-message">
                <i class="bi bi-fingerprint text-primary" style="font-size: 4rem;"></i>
                <h4 class="mt-3">Place Finger on Scanner</h4>
                <p class="text-muted">Identifying student...</p>
                <button type="button" class="btn btn-secondary mt-3" onclick="cancelFingerprintScan()">Cancel</button>
            </div>
        </div>

        <form id="order-form" method="POST" action="{% url 'place_order' %}">
            {% csrf_token %}

            <div class="row mb-3 p-3 border rounded bg-light">
                <div class="col-md-4 suggestions-container">
                    <label for="person-search" class="form-label">Search Customer (Optional)</label>
                    <input autocomplete="off" class="form-control" id="person-search" placeholder="Student or Staff name..." type="search">
                    <input id="student-id" name="student_id" type="hidden">
                    <input id="staff-id" name="staff_id" type="hidden">
                    <div id="person-suggestions" class="suggestions-list list-group"></div>
                </div>
                <div class="col-md-5">
                    <div class="customer-info">
                        <p class="mb-1">
                            <strong>Customer:</strong> <span id="customer-name">â€”</span>
                            <small id="customer-identifier" class="text-muted"></small>
                            <br>
                            <strong>Type:</strong> <span id="customer-type" class="text-muted">â€”</span>
                            <span id="customer-class-label" style="display:none;"><strong class="ms-2">Class:</strong> <span id="customer-class" class="text-muted">â€”</span></span>
                        </p>
                        <p class="mb-0">
                            <strong>Wallet:</strong> <span id="wallet-balance" class="text-success fw-bold">â‚¦0.00</span>
                        </p>
                    </div>
                </div>
                <div class="col-md-3 text-end">
                    <img id="customer-image" class="img-fluid rounded border" src="{% static 'admin_site/images/default_image.jpg' %}" style="max-height:80px; width: 80px; object-fit: cover;" alt="Customer Image">
                </div>
            </div>

            <div class="mb-3">
                <h6 class="text-muted"><i class="bi bi-star-fill text-warning"></i> Top Selling Items</h6>
                <div id="top-items-container">
                    {% for item in top_items %}
                        <span class="badge bg-secondary top-item-badge m-1 p-2"
                              data-item-id="{{ item.item__id }}"
                              data-item-name="{{ item.item__name }}"
                              data-item-price="{{ item.item__current_selling_price }}"
                              data-item-qty="{{ item.item__shop_quantity }}">
                            {{ item.item__name }}
                        </span>
                    {% endfor %}
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-bordered" id="order-table">
                    <thead class="table-dark">
                        <tr>
                            <th style="width: 5%;">Action</th>
                            <th style="width: 40%;">Item</th>
                            <th style="width: 10%;">Available</th>
                            <th style="width: 15%;">Unit Price (â‚¦)</th>
                            <th style="width: 15%;">Quantity</th>
                            <th style="width: 15%;">Total (â‚¦)</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="d-flex justify-content-end mb-3">
                <button type="button" class="btn btn-sm btn-success" id="add-item-row">
                    <i class="bi bi-plus-circle"></i> Add Item Row
                </button>
            </div>

            <div class="row mt-3 justify-content-end">
                <div class="col-md-6">
                    <div class="row g-3">
                        <div class="col-6"><label class="form-label">Subtotal</label><input class="form-control" id="subtotal" readonly></div>
                        <div class="col-6"><label class="form-label">Discount</label><input class="form-control" id="discount" name="discount" type="number" min="0" step="0.01" value="0.00"></div>
                        <div class="col-6">
                            <label class="form-label">Payment Method</label>
                            <select name="payment_method" id="payment-method" class="form-select" required>
                                <option value="cash">Cash</option>
                                <option value="pos">POS</option>
                                <option value="student_wallet" disabled>Student Wallet</option>
                                <option value="staff_wallet" disabled>Staff Wallet</option>
                            </select>
                        </div>
                        <div class="col-6"><label class="form-label">Grand Total</label><input class="form-control fs-5 fw-bold" id="grand-total" readonly></div>
                    </div>
                </div>
            </div>

            <div class="text-center mt-4">
                <button class="btn btn-primary btn-lg px-5" type="submit"><i class="bi bi-cart-check"></i> Place Order</button>
                <button type="button" class="btn btn-outline-secondary btn-lg px-4 ms-2" id="clear-form-btn"><i class="bi bi-arrow-clockwise"></i> Clear Form</button>
            </div>
        </form>
    </div>
</div>

<template id="order-row-template">
    <tr class="order-row">
        <td class="text-center align-middle"><button type="button" class="btn btn-sm btn-outline-danger remove-row"><i class="bi bi-x-lg"></i></button></td>
        <td class="suggestions-container">
            <input class="form-control item-search" placeholder="Search item or scan barcode..." type="text">
            <input class="item-id" name="items[__INDEX__][item_id]" type="hidden">
            <div class="suggestions-list item-suggestions list-group"></div>
        </td>
        <td class="text-center align-middle"><span class="qty-available badge bg-info">â€”</span></td>
        <td class="text-center align-middle"><span class="unit-price">â€”</span></td>
        <td><input class="form-control quantity-input text-center" min="0.01" step="0.01" name="items[__INDEX__][quantity]" type="number" value="1" disabled></td>
        <td class="text-center align-middle"><strong class="total-price">â€”</strong></td>
    </tr>
</template>

<!-- Include DigitalPersona SDK -->
<script type="text/javascript" src="https://unpkg.com/@digitalpersona/websdk@v1"></script>
<script type="text/javascript" src="https://unpkg.com/@digitalpersona/fingerprint@v1"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // --- CONFIGURATION ---
    const personSearchUrl = "{% url 'api_person_search' %}";
    const itemSearchUrl = "{% url 'api_item_search' %}";
    const barcodeLookupUrl = "{% url 'api_barcode_lookup' %}";
    const fingerprintIdentifyUrl = "{% url 'identify_student_by_fingerprint' %}";
    const defaultImage = "{% static 'admin_site/images/default_image.jpg' %}";
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;

    // --- DOM ELEMENTS ---
    const orderForm = document.getElementById('order-form');
    const personSearchInput = document.getElementById('person-search');
    const personSuggestions = document.getElementById('person-suggestions');
    const studentIdInput = document.getElementById('student-id');
    const staffIdInput = document.getElementById('staff-id');
    const paymentMethodSelect = document.getElementById('payment-method');
    const orderTableBody = document.querySelector('#order-table tbody');
    const rowTemplate = document.getElementById('order-row-template');

    let rowIndex = 0;
    let currentCustomerType = null;

    // --- FINGERPRINT SCANNER VARIABLES ---
    let fingerprintApi = null;
    let fingerprintEnabled = false;
    let isCapturing = false;

    // --- BARCODE SCANNER VARIABLES ---
    let barcodeBuffer = '';
    let barcodeTimer = null;
    const BARCODE_CHAR_DELAY = 50; // ms between characters for scanner detection
    const BARCODE_MIN_LENGTH = 3;
    let lastKeypressTime = 0;

    // =============================================================================
    // FINGERPRINT SCANNER FUNCTIONS
    // =============================================================================

    function updateFingerprintStatus(status, message, detail = '') {
        const icon = document.getElementById('fp-status-icon');
        const text = document.getElementById('fp-status-text');
        const detailEl = document.getElementById('fp-status-detail');

        const statusConfig = {
            ready: { icon: 'check-circle text-success', class: 'scanner-pulse' },
            scanning: { icon: 'fingerprint text-primary', class: 'scanner-pulse' },
            error: { icon: 'x-circle text-danger', class: '' },
            disabled: { icon: 'slash-circle text-secondary', class: '' }
        };

        const config = statusConfig[status] || statusConfig.disabled;
        icon.innerHTML = `<i class="bi bi-${config.icon}"></i>`;
        icon.className = `me-2 ${config.class}`;
        text.textContent = message;
        detailEl.textContent = detail;
    }

    function onCommunicationFailed(event) {
        console.error('Fingerprint communication failed:', event.error);
        updateFingerprintStatus('error', 'Connection Failed', 'Check if agent is running');
    }

    function onDeviceConnected(event) {
        console.log('Fingerprint device connected:', event.deviceUid);
        updateFingerprintStatus('ready', 'Scanner Ready', 'Ready to scan fingerprints');
    }

    function onDeviceDisconnected(event) {
        console.log('Fingerprint device disconnected:', event.deviceUid);
        updateFingerprintStatus('error', 'Scanner Disconnected', 'Please reconnect the device');
    }

    function onAcquisitionStarted(event) {
        console.log('Fingerprint acquisition started:', event.deviceUid);
        document.getElementById('scan-overlay').classList.add('active');
        updateFingerprintStatus('scanning', 'Scanning...', 'Hold finger steady');
    }

    function onAcquisitionStopped(event) {
        console.log('Fingerprint acquisition stopped:', event.deviceUid);
        document.getElementById('scan-overlay').classList.remove('active');
        if (fingerprintEnabled && !isCapturing) {
            updateFingerprintStatus('ready', 'Scanner Ready', 'Ready to scan fingerprints');
        }
    }

    async function onSamplesAcquired(event) {
        console.log('Fingerprint sample acquired:', event.deviceUid);

        try {
            const samples = JSON.parse(event.samples);
            if (!samples || samples.length === 0) {
                throw new Error('No samples captured');
            }

            const sample = samples[0];
            const standardBase64 = base64urlToBase64(sample);

            // Send to server for identification
            updateFingerprintStatus('scanning', 'Identifying...', 'Matching fingerprint');

            const response = await fetch(fingerprintIdentifyUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    fingerprint_data: standardBase64
                })
            });

            const data = await response.json();

            if (response.ok && data.success) {
                // Student identified!
                populateCustomer({
                    type: 'student',
                    id: data.student.id,
                    name: data.student.name,
                    identifier: data.student.reg_number,
                    display_class: data.student.student_class + ' ' + data.student.class_section,
                    wallet_balance: data.student.wallet_balance,
                    image_url: data.student.image_url
                });

                updateFingerprintStatus('ready', 'Student Identified!', `${data.student.name} - Match: ${(data.match_details.score * 100).toFixed(1)}%`);

                // Show success feedback
                showToast('success', `Student identified: ${data.student.name}`);

                // Auto-restart scanning after 2 seconds
                setTimeout(() => {
                    if (fingerprintEnabled) {
                        startFingerprintCapture();
                    }
                }, 2000);
            } else {
                throw new Error(data.message || 'Identification failed');
            }

        } catch (error) {
            console.error('Error processing fingerprint:', error);
            updateFingerprintStatus('error', 'Identification Failed', error.message);
            showToast('danger', `Fingerprint not recognized: ${error.message}`);

            // Restart scanning after error
            setTimeout(() => {
                if (fingerprintEnabled) {
                    startFingerprintCapture();
                }
            }, 2000);
        } finally {
            document.getElementById('scan-overlay').classList.remove('active');
        }
    }

    function onQualityReported(event) {
        console.log('Fingerprint quality:', event.quality);
    }

    function onErrorOccurred(event) {
        console.error('Fingerprint error:', event.error);
        updateFingerprintStatus('error', 'Scanner Error', event.error?.message || 'Unknown error');
        document.getElementById('scan-overlay').classList.remove('active');
    }

    async function initializeFingerprintAPI() {
        try {
            if (typeof Fingerprint === 'undefined' || !Fingerprint.WebApi) {
                throw new Error('DigitalPersona SDK not loaded');
            }

            fingerprintApi = new Fingerprint.WebApi();

            // Register event handlers
            fingerprintApi.onCommunicationFailed = onCommunicationFailed;
            fingerprintApi.onDeviceConnected = onDeviceConnected;
            fingerprintApi.onDeviceDisconnected = onDeviceDisconnected;
            fingerprintApi.onAcquisitionStarted = onAcquisitionStarted;
            fingerprintApi.onAcquisitionStopped = onAcquisitionStopped;
            fingerprintApi.onSamplesAcquired = onSamplesAcquired;
            fingerprintApi.onQualityReported = onQualityReported;
            fingerprintApi.onErrorOccurred = onErrorOccurred;

            console.log('Fingerprint API initialized');
            return true;
        } catch (error) {
            console.error('Failed to initialize fingerprint API:', error);
            updateFingerprintStatus('error', 'Initialization Failed', error.message);
            return false;
        }
    }

    async function startFingerprintCapture() {
        if (isCapturing) return;

        try {
            await fingerprintApi.startAcquisition(Fingerprint.SampleFormat.PngImage);
            isCapturing = true;
            updateFingerprintStatus('ready', 'Scanner Active', 'Place finger to identify');
        } catch (error) {
            console.error('Error starting fingerprint capture:', error);
            updateFingerprintStatus('error', 'Start Failed', error.message);
        }
    }

    async function stopFingerprintCapture() {
        if (!isCapturing) return;

        try {
            await fingerprintApi.stopAcquisition();
            isCapturing = false;
        } catch (error) {
            console.error('Error stopping fingerprint capture:', error);
        }
    }

    function base64urlToBase64(base64url) {
        let base64 = base64url.replace(/-/g, '+').replace(/_/g, '/');
        const padding = base64.length % 4;
        if (padding) {
            base64 += '='.repeat(4 - padding);
        }
        return base64;
    }

    window.cancelFingerprintScan = function() {
        document.getElementById('scan-overlay').classList.remove('active');
        if (fingerprintEnabled) {
            stopFingerprintCapture();
            setTimeout(() => startFingerprintCapture(), 500);
        }
    };

    // Toggle fingerprint scanner
    document.getElementById('toggle-fingerprint-scanner').addEventListener('click', async function() {
        const statusDiv = document.getElementById('fingerprint-status');
        const btn = this;

        if (!fingerprintEnabled) {
            // Enable scanner
            btn.disabled = true;
            btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Initializing...';

            const initialized = await initializeFingerprintAPI();
            if (initialized) {
                fingerprintEnabled = true;
                statusDiv.style.display = 'block';
                btn.innerHTML = '<i class="bi bi-fingerprint"></i> Scanner Active';
                btn.classList.remove('btn-outline-primary');
                btn.classList.add('btn-primary');
                await startFingerprintCapture();
            } else {
                btn.innerHTML = '<i class="bi bi-fingerprint"></i> Enable Fingerprint Scanner';
                showToast('danger', 'Failed to initialize fingerprint scanner');
            }
            btn.disabled = false;
        }
    });

    document.getElementById('stop-fingerprint-scanner').addEventListener('click', async function() {
        fingerprintEnabled = false;
        await stopFingerprintCapture();
        document.getElementById('fingerprint-status').style.display = 'none';
        document.getElementById('scan-overlay').classList.remove('active');

        const toggleBtn = document.getElementById('toggle-fingerprint-scanner');
        toggleBtn.innerHTML = '<i class="bi bi-fingerprint"></i> Enable Fingerprint Scanner';
        toggleBtn.classList.remove('btn-primary');
        toggleBtn.classList.add('btn-outline-primary');
    });

    // =============================================================================
    // BARCODE SCANNER FUNCTIONS
    // =============================================================================

    function handleBarcodeInput(char, isEnter) {
        const currentTime = Date.now();
        const timeDiff = currentTime - lastKeypressTime;

        // If it's a fast keypress (likely scanner) and not Enter
        if (!isEnter && timeDiff < BARCODE_CHAR_DELAY) {
            barcodeBuffer += char;

            // Clear any existing timer
            if (barcodeTimer) {
                clearTimeout(barcodeTimer);
            }

            // Set new timer to process barcode
            barcodeTimer = setTimeout(() => {
                if (barcodeBuffer.length >= BARCODE_MIN_LENGTH) {
                    processBarcodeData(barcodeBuffer);
                }
                barcodeBuffer = '';
            }, 100);
        } else if (isEnter && barcodeBuffer.length >= BARCODE_MIN_LENGTH) {
            // Enter key pressed with buffered data
            processBarcodeData(barcodeBuffer);
            barcodeBuffer = '';
        } else {
            // Reset if timing doesn't match scanner pattern
            barcodeBuffer = char;
        }

        lastKeypressTime = currentTime;
    }

    async function processBarcodeData(barcode) {
        console.log('Processing barcode:', barcode);

        try {
            const response = await fetch(`${barcodeLookupUrl}?barcode=${encodeURIComponent(barcode)}`);
            const data = await response.json();

            if (data.success) {
                if (data.student) {
                    // Student barcode scanned
                    populateCustomer({
                        type: 'student',
                        id: data.student.id,
                        name: data.student.name,
                        identifier: data.student.reg_number,
                        display_class: data.student.student_class,
                        wallet_balance: data.student.wallet_balance,
                        image_url: data.student.image_url
                    });
                    showToast('success', `Student identified: ${data.student.name}`);
                } else if (data.item) {
                    // Product barcode scanned
                    addItemToNextAvailableRow(data.item);
                    showToast('success', `Item added: ${data.item.name}`);
                }
            } else {
                showToast('warning', `Barcode not found: ${barcode}`);
            }
        } catch (error) {
            console.error('Barcode lookup error:', error);
            showToast('danger', 'Error processing barcode');
        }
    }

    // Global keydown listener for barcode scanner
    document.addEventListener('keydown', function(e) {
        // Ignore if typing in textarea or contenteditable
        if (e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) {
            return;
        }

        if (e.key === 'Enter') {
            // Check if we have barcode buffer
            if (barcodeBuffer.length >= BARCODE_MIN_LENGTH) {
                e.preventDefault();
                handleBarcodeInput('', true);

                // Clear the input field if it was focused and has the barcode
                if (e.target.tagName === 'INPUT' && e.target.value === barcodeBuffer) {
                    e.target.value = '';
                }
            }
        } else if (e.key.length === 1 && !e.ctrlKey && !e.altKey && !e.metaKey) {
            // Regular character key
            const currentTime = Date.now();
            const timeDiff = currentTime - lastKeypressTime;

            // If fast typing detected (scanner pattern)
            if (timeDiff < BARCODE_CHAR_DELAY && barcodeBuffer.length > 0) {
                // Prevent the character from being typed in input fields
                if (e.target.tagName === 'INPUT') {
                    e.preventDefault();
                }
                handleBarcodeInput(e.key, false);
            } else {
                // Normal typing - allow it
                handleBarcodeInput(e.key, false);
            }
        }
    });

    // =============================================================================
    // CUSTOMER MANAGEMENT FUNCTIONS
    // =============================================================================

    personSearchInput.addEventListener('input', debounce(function() {
        const query = this.value;
        if (query.length < 2) {
            personSuggestions.innerHTML = '';
            return;
        }

        fetch(`${personSearchUrl}?q=${encodeURIComponent(query)}`)
            .then(res => res.json())
            .then(data => {
                let html = '';
                if (data.length) {
                    data.forEach(person => {
                        const badgeClass = person.type === 'student' ? 'type-student' : 'type-staff';
                        const typeLabel = person.type === 'student' ? 'Student' : 'Staff';
                        html += `<a href="#" class="list-group-item list-group-item-action suggestion-item person-option" data-person='${JSON.stringify(person)}'>
                            <span class="type-badge ${badgeClass}">${typeLabel}</span>
                            ${person.name} (${person.identifier})
                        </a>`;
                    });
                } else {
                    html = '<div class="list-group-item">No customers found.</div>';
                }
                personSuggestions.innerHTML = html;
            });
    }, 300));

    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('person-option') || e.target.closest('.person-option')) {
            e.preventDefault();
            const optionEl = e.target.classList.contains('person-option') ? e.target : e.target.closest('.person-option');
            const personData = JSON.parse(optionEl.dataset.person);
            populateCustomer(personData);
        }
        if (!e.target.closest('.suggestions-container')) {
            document.querySelectorAll('.suggestions-list').forEach(el => el.innerHTML = '');
        }
    });

    function populateCustomer(person) {
        studentIdInput.value = '';
        staffIdInput.value = '';

        if (person.type === 'student') {
            studentIdInput.value = person.id;
            currentCustomerType = 'student';
            document.getElementById('customer-class-label').style.display = '';
            document.getElementById('customer-class').textContent = person.display_class || 'â€”';
            paymentMethodSelect.value = 'student_wallet';
            paymentMethodSelect.querySelector('option[value="student_wallet"]').disabled = false;
            paymentMethodSelect.querySelector('option[value="staff_wallet"]').disabled = true;
        } else {
            staffIdInput.value = person.id;
            currentCustomerType = 'staff';
            document.getElementById('customer-class-label').style.display = 'none';
            paymentMethodSelect.value = 'staff_wallet';
            paymentMethodSelect.querySelector('option[value="staff_wallet"]').disabled = false;
            paymentMethodSelect.querySelector('option[value="student_wallet"]').disabled = true;
        }

        document.getElementById('customer-name').textContent = person.name;
        document.getElementById('customer-identifier').textContent = `(${person.identifier})`;
        document.getElementById('customer-type').textContent = person.type === 'student' ? 'Student' : 'Staff';
        document.getElementById('wallet-balance').textContent = 'â‚¦' + parseFloat(person.wallet_balance || 0).toFixed(2);
        document.getElementById('customer-image').src = person.image_url || defaultImage;
        personSearchInput.value = person.name;
        personSuggestions.innerHTML = '';
    }

    function clearCustomer() {
        studentIdInput.value = '';
        staffIdInput.value = '';
        currentCustomerType = null;
        document.getElementById('customer-name').textContent = 'â€”';
        document.getElementById('customer-identifier').textContent = '';
        document.getElementById('customer-type').textContent = 'â€”';
        document.getElementById('customer-class').textContent = 'â€”';
        document.getElementById('customer-class-label').style.display = 'none';
        document.getElementById('wallet-balance').textContent = 'â‚¦0.00';
        document.getElementById('customer-image').src = defaultImage;
        personSearchInput.value = '';
        paymentMethodSelect.value = 'cash';
        paymentMethodSelect.querySelector('option[value="student_wallet"]').disabled = true;
        paymentMethodSelect.querySelector('option[value="staff_wallet"]').disabled = true;
    }

    // =============================================================================
    // ITEM & ORDER ROW MANAGEMENT
    // =============================================================================

    function addNewRow() {
        const newRow = rowTemplate.content.cloneNode(true);
        const rowElement = newRow.querySelector('tr');
        rowElement.innerHTML = rowElement.innerHTML.replace(/__INDEX__/g, rowIndex);
        orderTableBody.appendChild(newRow);
        rowIndex++;
        bindRowEvents(orderTableBody.lastElementChild);
        return orderTableBody.lastElementChild;
    }

    function bindRowEvents(row) {
        row.querySelector('.remove-row').addEventListener('click', () => {
            if (orderTableBody.querySelectorAll('tr').length > 1) {
                row.remove();
                updateTotals();
            }
        });

        row.querySelector('.item-search').addEventListener('input', debounce(function() {
            const input = this;
            const query = input.value;
            const suggestionsEl = row.querySelector('.item-suggestions');

            if (query.length < 2) {
                suggestionsEl.innerHTML = '';
                return;
            }

            fetch(`${itemSearchUrl}?q=${encodeURIComponent(query)}`)
                .then(res => res.json())
                .then(data => {
                    let html = '';
                    if(data.length) {
                        data.forEach(i => {
                            html += `<a href="#" class="list-group-item list-group-item-action suggestion-item item-option" data-item='${JSON.stringify(i)}'>${i.name} (Available: ${i.qty_remaining})</a>`;
                        });
                    } else {
                        html = '<div class="list-group-item">No items found.</div>';
                    }
                    suggestionsEl.innerHTML = html;
                });
        }, 300));

        row.querySelector('.quantity-input').addEventListener('input', () => updateTotals());
    }

    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('item-option')) {
            e.preventDefault();
            const itemData = JSON.parse(e.target.dataset.item);
            const row = e.target.closest('tr');
            fillRowWithItem(row, itemData);
        }
    });

    function fillRowWithItem(row, item) {
        if (!row) return;

        // Check for duplicates
        let isDuplicate = false;
        orderTableBody.querySelectorAll('.item-id').forEach(inputId => {
            if (inputId.value == item.id) {
                isDuplicate = true;
            }
        });

        if (isDuplicate) {
            showToast('warning', `Item "${item.name}" is already in the order.`);
            return;
        }

        row.querySelector('.item-search').value = item.name;
        row.querySelector('.item-id').value = item.id;
        row.querySelector('.qty-available').textContent = item.qty_remaining;
        row.querySelector('.unit-price').textContent = parseFloat(item.selling_price).toFixed(2);

        const qtyInput = row.querySelector('.quantity-input');
        qtyInput.disabled = false;
        qtyInput.setAttribute('max', item.qty_remaining);

        row.querySelector('.item-suggestions').innerHTML = '';
        updateTotals();
        ensureEmptyRow();
        qtyInput.focus();
        qtyInput.select();
    }

    function addItemToNextAvailableRow(itemData) {
        let emptyRow = null;
        orderTableBody.querySelectorAll('tr').forEach(row => {
            if (!row.querySelector('.item-id').value && !emptyRow) {
                emptyRow = row;
            }
        });

        if (!emptyRow) {
            emptyRow = addNewRow();
        }
        fillRowWithItem(emptyRow, itemData);
    }

    document.getElementById('top-items-container').addEventListener('click', function(e) {
        if (e.target.classList.contains('top-item-badge')) {
            const itemData = {
                id: e.target.dataset.itemId,
                name: e.target.dataset.itemName,
                selling_price: e.target.dataset.itemPrice,
                qty_remaining: e.target.dataset.itemQty
            };
            addItemToNextAvailableRow(itemData);
        }
    });

    function ensureEmptyRow() {
        let hasEmptyRow = false;
        orderTableBody.querySelectorAll('tr').forEach(row => {
            if (!row.querySelector('.item-id').value) {
                hasEmptyRow = true;
            }
        });
        if (!hasEmptyRow) {
            addNewRow();
        }
    }

    // =============================================================================
    // CALCULATIONS & FORM SUBMISSION
    // =============================================================================

    document.getElementById('discount').addEventListener('input', () => updateTotals());
    document.getElementById('add-item-row').addEventListener('click', () => addNewRow());

    document.getElementById('clear-form-btn').addEventListener('click', () => {
        if(confirm('Are you sure you want to clear this entire form?')) {
            location.reload();
        }
    });

    function updateTotals() {
        let subtotal = 0;
        orderTableBody.querySelectorAll('.order-row').forEach(row => {
            const qty = parseFloat(row.querySelector('.quantity-input').value) || 0;
            const price = parseFloat(row.querySelector('.unit-price').textContent) || 0;
            const total = qty * price;
            row.querySelector('.total-price').textContent = `â‚¦${total.toFixed(2)}`;
            subtotal += total;
        });

        const discount = parseFloat(document.getElementById('discount').value) || 0;
        const grandTotal = Math.max(0, subtotal - discount);

        document.getElementById('subtotal').value = `â‚¦${subtotal.toFixed(2)}`;
        document.getElementById('grand-total').value = `â‚¦${grandTotal.toFixed(2)}`;
    }

    orderForm.addEventListener('submit', function(e) {
        let hasItems = false;
        orderTableBody.querySelectorAll('.order-row').forEach(row => {
            if(row.querySelector('.item-id').value) {
                hasItems = true;
            }
        });

        if (!hasItems) {
            e.preventDefault();
            showToast('danger', 'Please add at least one item to the order.');
            return;
        }

        const paymentMethod = paymentMethodSelect.value;
        const grandTotal = parseFloat(document.getElementById('grand-total').value.replace('â‚¦', '')) || 0;
        const balance = parseFloat(document.getElementById('wallet-balance').textContent.replace('â‚¦', '')) || 0;

        if (paymentMethod === 'student_wallet') {
            if (!studentIdInput.value) {
                e.preventDefault();
                showToast('danger', 'Please select a student for wallet payment.');
                return;
            }
            if (grandTotal > balance) {
                e.preventDefault();
                showToast('danger', `Insufficient funds. Available: â‚¦${balance.toFixed(2)}, Required: â‚¦${grandTotal.toFixed(2)}`);
                return;
            }
        } else if (paymentMethod === 'staff_wallet') {
            if (!staffIdInput.value) {
                e.preventDefault();
                showToast('danger', 'Please select a staff member for wallet payment.');
                return;
            }
            if (grandTotal > balance) {
                e.preventDefault();
                showToast('danger', `Insufficient funds. Available: â‚¦${balance.toFixed(2)}, Required: â‚¦${grandTotal.toFixed(2)}`);
                return;
            }
        }
    });

    // =============================================================================
    // UTILITY FUNCTIONS
    // =============================================================================

    function debounce(func, delay) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), delay);
        };
    }

    function showToast(type, message) {
        // Create toast notification (Bootstrap style)
        const toastHtml = `
            <div class="position-fixed top-0 end-0 p-3" style="z-index: 11000">
                <div class="toast show align-items-center text-white bg-${type} border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            </div>
        `;

        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = toastHtml;
        document.body.appendChild(tempDiv.firstElementChild);

        // Auto-remove after 3 seconds
        setTimeout(() => {
            const toastEl = document.querySelector('.toast.show');
            if (toastEl) {
                toastEl.closest('.position-fixed').remove();
            }
        }, 3000);
    }

    // =============================================================================
    // INITIALIZATION
    // =============================================================================

    clearCustomer();
    addNewRow();
    personSearchInput.focus();

    console.log('âœ… POS System Ready');
    console.log('ðŸ“± Barcode scanner: Active (scan products or student barcodes)');
    console.log('ðŸ‘† Fingerprint scanner: Click "Enable Fingerprint Scanner" button');
});
</script>

{% endblock %}