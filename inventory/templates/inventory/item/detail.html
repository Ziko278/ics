{% extends 'admin_site/layout.html' %}
{% block 'main' %}
{% load humanize %}

<div class="pagetitle">
  <h1>Item Details</h1>
  <nav>
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="#">Dashboard</a></li>
      <li class="breadcrumb-item"><a href="{% url 'inventory_item_list' %}">Inventory Items</a></li>
      <li class="breadcrumb-item active">{{ item.name|title }}</li>
    </ol>
  </nav>
</div>

<div class="col-lg-12">
    <div class="card">
        <div class="card-body">
             <h5 class="card-title">Actions</h5>
            <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#stockOutModal"
                     data-max-shop="{{ item.shop_quantity }}" data-max-store="{{ item.store_quantity }}">
                 <i class="bi bi-box-arrow-up"></i> Stock Out
             </button>
             <a title="Edit Item" href="{% url 'inventory_item_update' item.pk %}" class="btn btn-warning">
                <i class="bi bi-pencil-square"></i> Edit
             </a>
             <a title="Delete Item" href="{% url 'inventory_item_delete' item.pk %}" class="btn btn-danger">
                <i class="bi bi-trash"></i> Delete
             </a>
             <a href="{% url 'inventory_item_list' %}" title="Go Back" style="float:right" class="btn btn-secondary"><i class="bi bi-arrow-left"></i> Back to List</a>
        </div>
    </div>
</div>


<div class="col-md-12">
    <div class="card">
        <div class="card-body pt-3">
            <ul class="nav nav-tabs nav-tabs-bordered">
                <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#item-details">Item Details</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#stock-levels">Stock Levels & Alerts</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#stock-movements">Stock Movements</button></li>
            </ul>

            <div class="tab-content pt-2">
                <!-- Item Details Tab -->
                <div class="tab-pane fade show active profile-overview" id="item-details">
                    <h5 class="card-title">Item Information</h5>
                    <div class="row mb-2">
                        <div class="col-lg-4 col-md-4 label fw-bold">Item Name</div>
                        <div class="col-lg-8 col-md-8">{{ item.name|title }}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-lg-4 col-md-4 label fw-bold">Category</div>
                        <div class="col-lg-8 col-md-8"><a href="#">{{ item.category.name|title }}</a></div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-lg-4 col-md-4 label fw-bold">Barcode (SKU)</div>
                        <div class="col-lg-8 col-md-8">{{ item.barcode|upper|default:"Not Set" }}</div>
                    </div>
                     <div class="row mb-2">
                        <div class="col-lg-4 col-md-4 label fw-bold">Unit of Measure</div>
                        <div class="col-lg-8 col-md-8">{{ item.get_unit_display }}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-lg-4 col-md-4 label fw-bold">Location</div>
                        <div class="col-lg-8 col-md-8">{{ item.get_location_display }}</div>
                    </div>
                     <div class="row mb-2">
                        <div class="col-lg-4 col-md-4 label fw-bold">Selling Price</div>
                        <div class="col-lg-8 col-md-8">₦{{ item.current_selling_price|floatformat:2|intcomma }}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-lg-4 col-md-4 label fw-bold">Status</div>
                        <div class="col-lg-8 col-md-8">
                            {% if item.is_active %}
                                <span class="badge bg-success"><i class="bi bi-check-circle me-1"></i> Active</span>
                            {% else %}
                                <span class="badge bg-danger"><i class="bi bi-x-circle me-1"></i> Inactive</span>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Stock Levels Tab -->
                <div class="tab-pane fade" id="stock-levels">
                    <h5 class="card-title">Current Stock Levels</h5>
                    <div class="row mb-2">
                        <div class="col-lg-4 col-md-4 label fw-bold">Quantity in Shop</div>
                        <div class="col-lg-8 col-md-8">{{ item.shop_quantity|floatformat:2|intcomma }}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-lg-4 col-md-4 label fw-bold">Quantity in Store</div>
                        <div class="col-lg-8 col-md-8">{{ item.store_quantity|floatformat:2|intcomma }}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-lg-4 col-md-4 label fw-bold">Total Quantity</div>
                        <div class="col-lg-8 col-md-8">
                            {% if item.is_low_stock %}
                                <span class="badge bg-warning text-dark"><i class="bi bi-exclamation-triangle-fill"></i> Low Stock: {{ item.total_quantity|floatformat:2|intcomma }}</span>
                            {% else %}
                                <strong>{{ item.total_quantity|floatformat:2|intcomma }}</strong>
                            {% endif %}
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-lg-4 col-md-4 label fw-bold">Re-order Level</div>
                        <div class="col-lg-8 col-md-8">{{ item.reorder_level|floatformat:2|intcomma }}</div>
                    </div>
                </div>

                <!-- Stock Movements Tab -->
                <div class="tab-pane fade" id="stock-movements">
                    <h5 class="card-title">Stock Ins (Purchases / Additions)</h5>
                    <div class="table-responsive">
                        <table class="table table-striped table-sm">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Qty Received</th>
                                    <th>Qty Remaining</th>
                                    <th>Location</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for entry in stock_ins %}
                                <tr>
                                    <td>{{ entry.stock_in.date_received|date:"d M, Y" }}</td>
                                    <td>{{ entry.quantity_received|floatformat:2|intcomma }}</td>
                                    <td>{{ entry.quantity_remaining|floatformat:2|intcomma }}</td>
                                    <td>{{ entry.stock_in.get_location_display }}</td>
                                    <td>
                                        {% if entry.quantity_remaining > 0 %}
                                        <button type="button" class="btn btn-outline-info btn-sm" data-bs-toggle="modal"
                                                data-bs-target="#stockOutModal"
                                                data-location="{{ entry.stock_in.location }}"
                                                data-max-specific="{{ entry.quantity_remaining }}"
                                                data-batch-id="{{ entry.pk }}">
                                            Stock Out
                                        </button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr><td colspan="5" class="text-center">No stock-in records found.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <h5 class="card-title mt-4">Stock Outs (Sales / Removals)</h5>
                    <div class="table-responsive">
                         <table class="table table-striped table-sm">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Quantity</th>
                                    <th>Location</th>
                                    <th>Reason</th>
                                    <th>By</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for entry in stock_outs %}
                                <tr>
                                    <td>{{ entry.date_removed|date:"d M, Y" }}</td>
                                    <td>-{{ entry.quantity_removed|floatformat:2|intcomma }}</td>
                                    <td>{{ entry.get_location_display }}</td>
                                    <td>{{ entry.get_reason_display }}</td>
                                    <td>{{ entry.created_by.staff_profile.staff|default:"System" }}</td>
                                </tr>
                                {% empty %}
                                <tr><td colspan="5" class="text-center">No stock-out records found.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                     <h5 class="card-title mt-4">Stock Transfers</h5>
                    <div class="table-responsive">
                         <table class="table table-striped table-sm">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Quantity</th>
                                    <th>Direction</th>
                                    <th>By</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for entry in stock_transfers %}
                                <tr>
                                    <td>{{ entry.transfer_date|date:"d M, Y" }}</td>
                                    <td>{{ entry.quantity|floatformat:2|intcomma }}</td>
                                    <td>Store <i class="bi bi-arrow-right"></i> Shop</td>
                                    <td>{{ entry.created_by.staff_profile.staff|default:"System" }}</td>
                                </tr>
                                {% empty %}
                                <tr><td colspan="4" class="text-center">No transfer records found.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div><!-- End Tab Content -->
        </div>
    </div>
</div>

<!-- Stock Out Modal -->
<div class="modal fade" id="stockOutModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Record Stock Out for: {{ item.name|title }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="stockOutForm" method="POST" action="{% url 'inventory_item_stock_out' item.pk %}">
                    {% csrf_token %}
                    {{ stock_out_form.specific_batch_id }}
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Reason</label>
                            <select name="reason" id="id_reason" class="form-select" required>
                                <option value="">---------</option>
                                <option value="staff_collection">Staff Collection</option>
                                <option value="damage">Damage</option>
                                <option value="expired">Expired</option>
                                <option value="adjustment">Stock Adjustment</option>
                                <option value="wastage">Wastage</option>
                                <option value="cafeteria">Cafeteria</option>
                                <option value="boarding house store">Boarding House Store</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Location</label>
                            <select name="location" id="id_location" class="form-select" required>
                                <option value="store">Store</option>
                                <option value="shop">Shop</option>
                            </select>
                        </div>
                        <div class="col-12" id="staff-recipient-field" style="display: none;">
                            <label class="form-label">Staff Recipient</label>
                            {{ stock_out_form.staff_recipient }}
                        </div>
                        <div class="col-12">
                            <label class="form-label">Quantity to Remove</label>
                            <input type="number" name="quantity_removed" class="form-control" required min="0.01" step="0.01">
                            <div class="form-text" id="quantity-helper-text"></div>
                        </div>
                         <div class="col-12">
                            <label class="form-label">Notes</label>
                            <textarea name="notes" class="form-control" rows="2"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="stockOutForm" class="btn btn-primary">Save Stock Out</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const stockOutModal = document.getElementById('stockOutModal');
    const reasonSelect = stockOutModal.querySelector('#id_reason');
    const staffRecipientField = stockOutModal.querySelector('#staff-recipient-field');
    const locationSelect = stockOutModal.querySelector('#id_location');
    const quantityInput = stockOutModal.querySelector('input[name="quantity_removed"]');
    const quantityHelper = stockOutModal.querySelector('#quantity-helper-text');

    stockOutModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const maxShop = button.getAttribute('data-max-shop');
        const maxStore = button.getAttribute('data-max-store');
        const maxSpecific = button.getAttribute('data-max-specific');
        const location = button.getAttribute('data-location');
        const batchId = button.getAttribute('data-batch-id');
        const hiddenBatchIdInput = stockOutModal.querySelector('#id_specific_batch_id');
        hiddenBatchIdInput.value = batchId || '';

        // Logic to pre-select location and set max quantity
        if (location) { // Clicked from a specific batch
            locationSelect.value = location;
            locationSelect.disabled = true; // Don't let user change it
            quantityInput.max = maxSpecific;
            quantityHelper.textContent = `Max available from this batch: ${maxSpecific}`;

            // Create a hidden input to submit the value
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'location';
            hiddenInput.value = location; // ← Use the 'location' variable you already have
            stockOutModal.querySelector('form').appendChild(hiddenInput);
        } else { // Clicked from main "Stock Out" button
            locationSelect.disabled = false;
            updateMaxQuantity();
        }
    });

    locationSelect.addEventListener('change', updateMaxQuantity);

    function updateMaxQuantity() {
        const maxShop = document.querySelector('[data-max-shop]').getAttribute('data-max-shop');
        const maxStore = document.querySelector('[data-max-store]').getAttribute('data-max-store');
        if (locationSelect.value === 'shop') {
            quantityInput.max = maxShop;
            quantityHelper.textContent = `Max available in Shop: ${maxShop}`;
        } else {
            quantityInput.max = maxStore;
            quantityHelper.textContent = `Max available in Store: ${maxStore}`;
        }
    }

    reasonSelect.addEventListener('change', function() {
        if (this.value === 'staff_collection') {
            staffRecipientField.style.display = 'block';
            staffRecipientField.querySelector('select').required = true;
        } else {
            staffRecipientField.style.display = 'none';
            staffRecipientField.querySelector('select').required = false;
        }
    });
});
</script>
{% endblock %}